/*! (c) Philipp KÃ¶nig under GPL-3.0 */
"use strict";function _defineProperty(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}!function(e){window.translation=function(){var a=this,t=null,s={};this.opts={elm:{body:e("body"),title:e("head > title"),header:e("body > header"),content:e("section#content"),backToOverview:e("section#content > a.back"),save:e("section#content > div[data-name='langvars'] > header > button.save"),wrapper:{overview:e("section#content > div[data-name='overview']"),langvars:e("section#content > div[data-name='langvars']")}},classes:{hidden:"hidden",progress:"progress",loading:"loading",active:"active",langVarCategory:"category",languagesSelect:"languages",edit:"edit",success:"success",empty:"empty",incomplete:"incomplete"},attr:{success:"data-successtext",releaseStatus:"data-status"},ajax:{info:"https://blockbyte.de/ajax/extensions/bs/i18n/info",langvars:"https://blockbyte.de/ajax/extensions/bs/i18n/langvars",submit:"https://blockbyte.de/ajax/extensions/bs/i18n/submit"},manifest:chrome.runtime.getManifest()},this.run=function(){r("overview"),o(),n(),p(),a.helper.model.init(function(){a.helper.i18n.init(function(){a.helper.font.init(),a.helper.stylesheet.init(),a.helper.stylesheet.addStylesheets(["translation"],e(document)),a.helper.template.footer().insertAfter(a.opts.elm.content),a.helper.i18n.parseHtml(document),a.opts.elm.title.text(a.opts.elm.title.text()+" - "+a.helper.i18n.get("extension_name")),l(function(){c(),f(),a.opts.elm.body.removeClass(a.opts.classes.loading)})})})};var n=function(){a.opts.elm.header.prepend('<svg height="48" width="48" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>')},o=function(){a.helper={template:new window.TemplateHelper(a),i18n:new window.I18nHelper(a),font:new window.FontHelper(a),stylesheet:new window.StylesheetHelper(a),model:new window.ModelHelper(a)}},l=function(e){a.helper.model.call("languageInfos",function(a){s=a.infos,"function"==typeof e&&e()})},r=function(e){"overview"===e?a.opts.elm.backToOverview.addClass(a.opts.classes.hidden):a.opts.elm.backToOverview.removeClass(a.opts.classes.hidden),Object.keys(a.opts.elm.wrapper).forEach(function(t){t===e?a.opts.elm.wrapper[t].removeClass(a.opts.classes.hidden):a.opts.elm.wrapper[t].addClass(a.opts.classes.hidden)})},p=function(){Object.keys(a.opts.elm.wrapper).forEach(function(e){!1===a.opts.elm.wrapper[e].hasClass(a.opts.classes.hidden)&&(a.opts.elm.wrapper[e].addClass(a.opts.classes.loading),t=a.helper.template.loading().appendTo(a.opts.elm.wrapper[e]))})},i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300;setTimeout(function(){t&&t.remove(),Object.keys(a.opts.elm.wrapper).forEach(function(e){!1===a.opts.elm.wrapper[e].hasClass(a.opts.classes.hidden)&&a.opts.elm.wrapper[e].removeClass(a.opts.classes.loading)})},e)},c=function(){a.opts.elm.wrapper.overview.find("> div > ul").remove(),a.opts.elm.wrapper.overview.find("> div > select."+a.opts.classes.languagesSelect).remove();var t=new XMLHttpRequest;t.open("POST",a.opts.ajax.info,!0),t.onload=function(){var n=JSON.parse(t.responseText);if(n&&n.languages){var o=e("<ul />").appendTo(a.opts.elm.wrapper.overview.children("div"));n.languages.sort(function(e,a){return a.varsAmount!==e.varsAmount?a.varsAmount-e.varsAmount:s[e.name]&&s[a.name]?s[e.name].label>s[a.name].label?1:-1:1});var l=Object.assign({},s);n.languages.forEach(function(t){if(delete l[t.name],s[t.name]){var r=12*Math.PI*2,p=t.varsAmount/n.varsAmount*100,i="draft";s[t.name].available&&(i=d(t.categories,n.categories)?"incomplete":"released"),e("<li />").data("lang",t.name).append("<strong>"+s[t.name].label+"</strong>").append("<a href='#' class='"+a.opts.classes.edit+"' title='"+a.helper.i18n.get("translation_edit")+"'></a>").append("<svg class="+a.opts.classes.progress+" width='32' height='32' viewPort='0 0 16 16'><circle r='12' cx='16' cy='16'></circle><circle r='12' cx='16' cy='16' stroke-dashoffset='"+(100-p)/100*r+"' stroke-dasharray='"+r+"'></circle></svg>").append("<span class='"+a.opts.classes.progress+"'>"+Math.round(t.varsAmount/n.varsAmount*100)+"%</span>").append("<span "+a.opts.attr.releaseStatus+"='"+i+"' title='"+a.helper.i18n.get("translation_status_"+i)+"'></span>").appendTo(o)}});var r=e("<select class='"+a.opts.classes.languagesSelect+"' />").appendTo(a.opts.elm.wrapper.overview.children("div"));e("<option value='' />").text("Add language").appendTo(r),Object.keys(l).forEach(function(a){e("<option value='"+a+"' />").text(s[a].label).appendTo(r)})}m(),i()},t.send()},d=function(e,a){var t=!1;return Object.keys(e).some(function(s){if(("Settings"!==s||e[s]/a[s]*100>75)&&a[s]>e[s])return t=!0,!0}),t},v=function e(t,s){var n=new XMLHttpRequest;n.open("POST",a.opts.ajax.langvars,!0),n.onload=function(){var o=JSON.parse(n.responseText);if(o&&Object.getOwnPropertyNames(o).length>0){var l=_defineProperty({},t,o),r=a.helper.i18n.getDefaultLanguage();t!==r?e(r,function(e){l.default=e[r],"function"==typeof s&&s(l)}):"function"==typeof s&&s(l)}else s(null)};var o=new FormData;o.append("lang",t),n.send(o)},u=function(t){a.opts.elm.wrapper.langvars.data("lang",t),a.opts.elm.wrapper.langvars.find("div."+a.opts.classes.langVarCategory).remove(),a.opts.elm.wrapper.langvars.find("> header > h2").text(""),r("langvars"),p(),v(t,function(n){if(n){var o=n[t],l=0;Object.keys(o).forEach(function(r){var p=e("<div />").addClass(a.opts.classes.langVarCategory).append("<a href='#' />").append("<strong>"+r+"</strong>").appendTo(a.opts.elm.wrapper.langvars.children("div")),i=e("<ul />").appendTo(p),c={total:o[r].length,filled:0};o[r].forEach(function(t,o){t.value&&(c.filled++,l++);var p=e("<li />").append("<label>"+t.label+"</label>").appendTo(i);n.default&&n.default[r]&&n.default[r][o]&&e("<span />").html("<span>"+s[a.helper.i18n.getDefaultLanguage()].label+":</span>"+n.default[r][o].value||"").appendTo(p);var d=t.value||"";e("<textarea />").data({initial:d,name:t.name}).text(d).appendTo(p);0===d.length&&p.addClass(a.opts.classes.empty)}),e("<span />").html("<span>"+c.filled+"</span>/"+c.total).insertBefore(i),s[t].available&&c.filled>0&&c.total>c.filled&&(p.addClass(a.opts.classes.incomplete),p.children("a").attr("title",a.helper.i18n.get("translation_incomplete_info")))}),a.opts.elm.wrapper.langvars.find("> header > h2").text(a.helper.i18n.get("translation_"+(0===l?"add":"edit"))+" ("+s[t].label+")"),g()}else r("overview");i()})},f=function(){a.opts.elm.backToOverview.on("click",function(e){e.preventDefault(),r("overview")}),a.opts.elm.save.on("click",function(t){t.preventDefault();var s=+new Date,n=a.helper.template.loading().appendTo(a.opts.elm.body);a.opts.elm.body.addClass(a.opts.classes.loading);var o={};a.opts.elm.wrapper.langvars.find("textarea").forEach(function(a){var t=a.value;if(t&&t.trim().length>0){var s=e(a).data("initial");if((t=t.trim())!==s){var n=e(a).data("name");o[n]=t}}});var l=new XMLHttpRequest;l.open("POST",a.opts.ajax.submit,!0),l.onload=function(){setTimeout(function(){n.remove(),a.opts.elm.body.attr(a.opts.attr.success,a.helper.i18n.get("translation_submit_message")),a.opts.elm.body.addClass(a.opts.classes.success),setTimeout(function(){a.opts.elm.body.removeClass(a.opts.classes.loading),a.opts.elm.body.removeClass(a.opts.classes.success),location.reload(!0)},1500)},Math.max(0,1e3-(+new Date-s)))};var r=new FormData;r.append("lang",a.opts.elm.wrapper.langvars.data("lang")),r.append("vars",JSON.stringify(o)),l.send(r)})},m=function(){a.opts.elm.wrapper.overview.find("select."+a.opts.classes.languagesSelect).on("change",function(e){u(e.currentTarget.value)}),a.opts.elm.wrapper.overview.find("a."+a.opts.classes.edit).on("click",function(a){a.preventDefault(),u(e(a.currentTarget).parent("li").data("lang"))})},g=function(){a.opts.elm.wrapper.langvars.find("div."+a.opts.classes.langVarCategory+" > a").on("click",function(t){t.preventDefault();var s=e(t.currentTarget).parent();s.toggleClass(a.opts.classes.active),s.hasClass(a.opts.classes.active)&&s.hasClass(a.opts.classes.incomplete)&&(a.opts.elm.wrapper.langvars.children("div")[0].scrollTop=s[0].offsetTop+s.find("li."+a.opts.classes.empty)[0].offsetTop-50)}),a.opts.elm.wrapper.langvars.find("textarea").on("change input",function(t){t.preventDefault();var s=e(t.currentTarget).parents("div."+a.opts.classes.langVarCategory).eq(0),n=0;s.find("textarea").forEach(function(e){e.value&&e.value.trim().length>0&&n++}),s.find("> span > span").text(n)})}},(new window.translation).run()}(jsu);