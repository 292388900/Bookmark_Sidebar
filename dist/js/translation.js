/*! (c) Philipp KÃ¶nig under GPL-3.0 */
!(e=>{"use strict";window.translation=function(){let t=null,s={};this.opts={elm:{body:e("body"),title:e("head > title"),header:e("body > header"),content:e("section#content"),backToOverview:e("section#content > a.back"),save:e("section#content > div[data-name='langvars'] > header > button.save"),wrapper:{overview:e("section#content > div[data-name='overview']"),langvars:e("section#content > div[data-name='langvars']"),unavailable:e("section#content > div[data-name='unavailable']")}},classes:{hidden:"hidden",progress:"progress",initLoading:"initLoading",loading:"loading",active:"active",langVarCategory:"category",languagesSelect:"languages",edit:"edit",success:"success",empty:"empty",incomplete:"incomplete"},attr:{success:"data-successtext",releaseStatus:"data-status"},ajax:{info:"https://blockbyte.de/ajax/extensions/bs/i18n/info",langvars:"https://blockbyte.de/ajax/extensions/bs/i18n/langvars",submit:"https://blockbyte.de/ajax/extensions/bs/i18n/submit"},manifest:chrome.runtime.getManifest()},this.run=(()=>{n("overview"),l(),a(),o(),this.helper.model.init(()=>{this.helper.i18n.init(()=>{this.helper.font.init(),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["translation"],e(document)),this.helper.template.footer().insertAfter(this.opts.elm.content),this.helper.i18n.parseHtml(document),this.opts.elm.title.text(this.opts.elm.title.text()+" - "+this.helper.i18n.get("extension_name")),i(()=>{this.helper.model.call("websiteStatus",e=>{"available"===e.status?(r(),v()):(n("unavailable"),p())}),this.helper.model.call("trackPageView",{page:"/translation"}),this.opts.elm.body.removeClass(this.opts.classes.initLoading)})})})});let a=()=>{this.opts.elm.header.prepend('<svg height="48" width="48" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>')},l=()=>{this.helper={template:new window.TemplateHelper(this),i18n:new window.I18nHelper(this),font:new window.FontHelper(this),stylesheet:new window.StylesheetHelper(this),model:new window.ModelHelper(this)}},i=e=>{this.helper.model.call("languageInfos",t=>{s=t.infos,"function"==typeof e&&e()})},n=e=>{"overview"===e||"unavailable"===e?this.opts.elm.backToOverview.addClass(this.opts.classes.hidden):this.opts.elm.backToOverview.removeClass(this.opts.classes.hidden),Object.keys(this.opts.elm.wrapper).forEach(t=>{t===e?this.opts.elm.wrapper[t].removeClass(this.opts.classes.hidden):this.opts.elm.wrapper[t].addClass(this.opts.classes.hidden)})},o=()=>{Object.keys(this.opts.elm.wrapper).forEach(e=>{!1===this.opts.elm.wrapper[e].hasClass(this.opts.classes.hidden)&&(this.opts.elm.wrapper[e].addClass(this.opts.classes.loading),t=this.helper.template.loading().appendTo(this.opts.elm.wrapper[e]))})},p=(e=300)=>{setTimeout(()=>{t&&t.remove(),Object.keys(this.opts.elm.wrapper).forEach(e=>{!1===this.opts.elm.wrapper[e].hasClass(this.opts.classes.hidden)&&this.opts.elm.wrapper[e].removeClass(this.opts.classes.loading)})},e)},r=()=>{this.opts.elm.wrapper.overview.find("> div.scrollBox > div > ul").remove(),this.opts.elm.wrapper.overview.find("> div.scrollBox > div > select."+this.opts.classes.languagesSelect).remove();let t=new XMLHttpRequest;t.open("POST",this.opts.ajax.info,!0),t.onload=(()=>{let a=JSON.parse(t.responseText);if(a&&a.languages){let t=e("<ul />").appendTo(this.opts.elm.wrapper.overview.find("> div.scrollBox > div"));a.languages.sort((e,t)=>t.varsAmount!==e.varsAmount?t.varsAmount-e.varsAmount:s[e.name]&&s[t.name]?s[e.name].label>s[t.name].label?1:-1:1);let l=Object.assign({},s);a.languages.forEach(i=>{if(s[i.name]){let n=i.varsAmount/a.varsAmount*100;if(n>10){delete l[i.name];let o=12*Math.PI*2,p="draft";s[i.name].available&&(p=d(i.categories,a.categories)?"incomplete":"released"),e("<li />").data("lang",i.name).append("<strong>"+s[i.name].label+"</strong>").append("<a href='#' class='"+this.opts.classes.edit+"' title='"+this.helper.i18n.get("translation_edit")+"'></a>").append("<svg class="+this.opts.classes.progress+" width='32' height='32' viewPort='0 0 16 16'><circle r='12' cx='16' cy='16'></circle><circle r='12' cx='16' cy='16' stroke-dashoffset='"+(100-n)/100*o+"' stroke-dasharray='"+o+"'></circle></svg>").append("<span class='"+this.opts.classes.progress+"'>"+Math.round(i.varsAmount/a.varsAmount*100)+"%</span>").append("<span "+this.opts.attr.releaseStatus+"='"+p+"' title='"+this.helper.i18n.get("translation_status_"+p)+"'></span>").appendTo(t)}}}),h(l)}g(),p()}),t.send()},h=t=>{let a=e("<select class='"+this.opts.classes.languagesSelect+"' />").appendTo(this.opts.elm.wrapper.overview.find("> div.scrollBox > div"));e("<option value='' />").text("Add language").appendTo(a);let l=[];Object.keys(t).forEach(t=>{l.push({elm:e("<option value='"+t+"' />").text(s[t].label),label:s[t].label})}),l.sort((e,t)=>e.label>t.label?1:-1),l.forEach(e=>{e.elm.appendTo(a)})},d=(e,t)=>{let s=!1;return Object.keys(e).some(a=>{if(("Settings"!==a||e[a]/t[a]*100>75)&&t[a]>e[a])return s=!0,!0}),s},c=(e,t)=>{let s=new XMLHttpRequest;s.open("POST",this.opts.ajax.langvars,!0),s.onload=(()=>{let a=JSON.parse(s.responseText);if(a&&Object.getOwnPropertyNames(a).length>0){let s={[e]:a},l=this.helper.i18n.getDefaultLanguage();e!==l?c(l,e=>{s.default=e[l],"function"==typeof t&&t(s)}):"function"==typeof t&&t(s)}else t(null)});let a=new FormData;a.append("lang",e),s.send(a)},m=t=>{this.opts.elm.wrapper.langvars.data("lang",t),this.opts.elm.wrapper.langvars.find("div."+this.opts.classes.langVarCategory).remove(),this.opts.elm.wrapper.langvars.find("> header > h2").text(""),n("langvars"),o(),c(t,a=>{if(a){let l=a[t],i=0;Object.keys(l).forEach(n=>{let o=e("<div />").addClass(this.opts.classes.langVarCategory).append("<a href='#' />").append("<strong>"+n+"</strong>").appendTo(this.opts.elm.wrapper.langvars.find("> div.scrollBox > div")),p=e("<ul />").appendTo(o),r={total:l[n].length,filled:0};l[n].forEach((t,l)=>{t.value&&(r.filled++,i++);let o=e("<li />").append("<label>"+t.label+"</label>").appendTo(p);a.default&&a.default[n]&&a.default[n][l]&&e("<span />").html("<span>"+s[this.helper.i18n.getDefaultLanguage()].label+":</span>"+a.default[n][l].value||"").appendTo(o);let h=t.value||"";e("<textarea />").data({initial:h,name:t.name}).text(h).appendTo(o);0===h.length&&o.addClass(this.opts.classes.empty)}),e("<span />").html("<span>"+r.filled+"</span>/"+r.total).insertBefore(p),s[t].available&&r.filled>0&&r.total>r.filled&&(o.addClass(this.opts.classes.incomplete),o.children("a").attr("title",this.helper.i18n.get("translation_incomplete_info")))}),this.opts.elm.wrapper.langvars.find("> header > h2").text(this.helper.i18n.get("translation_"+(0===i?"add":"edit"))+" ("+s[t].label+")"),u()}else n("overview");p()})},v=()=>{this.opts.elm.backToOverview.on("click",e=>{e.preventDefault(),n("overview")}),this.opts.elm.save.on("click",t=>{t.preventDefault();let s=+new Date,a=this.helper.template.loading().appendTo(this.opts.elm.body);this.opts.elm.body.addClass(this.opts.classes.loading);let l={};this.opts.elm.wrapper.langvars.find("textarea").forEach(t=>{let s=t.value;if(s&&s.trim().length>0){let a=e(t).data("initial");if((s=s.trim())!==a){let a=e(t).data("name");l[a]=s}}});let i=new XMLHttpRequest;i.open("POST",this.opts.ajax.submit,!0),i.onload=(()=>{setTimeout(()=>{a.remove(),this.opts.elm.body.attr(this.opts.attr.success,this.helper.i18n.get("translation_submit_message")),this.opts.elm.body.addClass(this.opts.classes.success),setTimeout(()=>{this.opts.elm.body.removeClass(this.opts.classes.loading),this.opts.elm.body.removeClass(this.opts.classes.success),location.reload(!0)},1500)},Math.max(0,1e3-(+new Date-s)))});let n=new FormData;n.append("lang",this.opts.elm.wrapper.langvars.data("lang")),n.append("vars",JSON.stringify(l)),i.send(n)})},g=()=>{this.opts.elm.wrapper.overview.find("select."+this.opts.classes.languagesSelect).on("change",e=>{m(e.currentTarget.value)}),this.opts.elm.wrapper.overview.find("a."+this.opts.classes.edit).on("click",t=>{t.preventDefault(),m(e(t.currentTarget).parent("li").data("lang"))})},u=()=>{this.opts.elm.wrapper.langvars.find("div."+this.opts.classes.langVarCategory+" > a").on("click",t=>{t.preventDefault();let s=e(t.currentTarget).parent();s.toggleClass(this.opts.classes.active),s.hasClass(this.opts.classes.active)&&s.hasClass(this.opts.classes.incomplete)&&(this.opts.elm.wrapper.langvars.children("div.scrollBox")[0].scrollTop=s[0].offsetTop+s.find("li."+this.opts.classes.empty)[0].offsetTop-50)}),this.opts.elm.wrapper.langvars.find("textarea").on("change input",t=>{t.preventDefault();let s=e(t.currentTarget).parents("div."+this.opts.classes.langVarCategory).eq(0),a=0;s.find("textarea").forEach(e=>{e.value&&e.value.trim().length>0&&a++}),s.find("> span > span").text(a)})}},(new window.translation).run()})(jsu);