/*! (c) Philipp KÃ¶nig under GPL-3.0 */
"use strict";function a(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}!function(b){window.translation=function(){var c=this,d=null,e={};this.opts={elm:{body:b("body"),title:b("head > title"),header:b("body > header"),content:b("section#content"),backToOverview:b("section#content > a.back"),save:b("section#content > div[data-name='langvars'] > header > button.save"),wrapper:{overview:b("section#content > div[data-name='overview']"),langvars:b("section#content > div[data-name='langvars']")}},classes:{hidden:"hidden",progress:"progress",loading:"loading",active:"active",langVarCategory:"category",languagesSelect:"languages",edit:"edit",success:"success",empty:"empty",incomplete:"incomplete"},attr:{success:"data-successtext",releaseStatus:"data-status"},ajax:{info:"https://blockbyte.de/ajax/extensions/bs/i18n/info",langvars:"https://blockbyte.de/ajax/extensions/bs/i18n/langvars",submit:"https://blockbyte.de/ajax/extensions/bs/i18n/submit"},manifest:chrome.runtime.getManifest()},this.run=function(){i("overview"),g(),f(),j(),c.helper.model.init(function(){c.helper.i18n.init(function(){c.helper.font.init(),c.helper.stylesheet.init(),c.helper.stylesheet.addStylesheets(["translation"],b(document)),c.helper.template.footer().insertAfter(c.opts.elm.content),c.helper.i18n.parseHtml(document),c.opts.elm.title.text(c.opts.elm.title.text()+" - "+c.helper.i18n.get("extension_name")),h(function(){l(),p(),c.opts.elm.body.removeClass(c.opts.classes.loading)})})})};var f=function(){c.opts.elm.header.prepend('<svg height="48" width="48" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>')},g=function(){c.helper={template:new window.TemplateHelper(c),i18n:new window.I18nHelper(c),font:new window.FontHelper(c),stylesheet:new window.StylesheetHelper(c),model:new window.ModelHelper(c)}},h=function(a){c.helper.model.call("languageInfos",function(b){e=b.infos,"function"==typeof a&&a()})},i=function(a){"overview"===a?c.opts.elm.backToOverview.addClass(c.opts.classes.hidden):c.opts.elm.backToOverview.removeClass(c.opts.classes.hidden),Object.keys(c.opts.elm.wrapper).forEach(function(b){b===a?c.opts.elm.wrapper[b].removeClass(c.opts.classes.hidden):c.opts.elm.wrapper[b].addClass(c.opts.classes.hidden)})},j=function(){Object.keys(c.opts.elm.wrapper).forEach(function(a){!1===c.opts.elm.wrapper[a].hasClass(c.opts.classes.hidden)&&(c.opts.elm.wrapper[a].addClass(c.opts.classes.loading),d=c.helper.template.loading().appendTo(c.opts.elm.wrapper[a]))})},k=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300;setTimeout(function(){d&&d.remove(),Object.keys(c.opts.elm.wrapper).forEach(function(a){!1===c.opts.elm.wrapper[a].hasClass(c.opts.classes.hidden)&&c.opts.elm.wrapper[a].removeClass(c.opts.classes.loading)})},a)},l=function(){c.opts.elm.wrapper.overview.find("> div > ul").remove(),c.opts.elm.wrapper.overview.find("> div > select."+c.opts.classes.languagesSelect).remove();var a=new XMLHttpRequest;a.open("POST",c.opts.ajax.info,!0),a.onload=function(){var d=JSON.parse(a.responseText);if(d&&d.languages){var f=b("<ul />").appendTo(c.opts.elm.wrapper.overview.children("div"));d.languages.sort(function(a,b){return b.varsAmount!==a.varsAmount?b.varsAmount-a.varsAmount:e[a.name]&&e[b.name]?e[a.name].label>e[b.name].label?1:-1:1});var g=Object.assign({},e);d.languages.forEach(function(a){if(delete g[a.name],e[a.name]){var h=12*Math.PI*2,i=a.varsAmount/d.varsAmount*100,j="draft";e[a.name].available&&(j=m(a.categories,d.categories)?"incomplete":"released"),b("<li />").data("lang",a.name).append("<strong>"+e[a.name].label+"</strong>").append("<a href='#' class='"+c.opts.classes.edit+"' title='"+c.helper.i18n.get("translation_edit")+"'></a>").append("<svg class="+c.opts.classes.progress+" width='32' height='32' viewPort='0 0 16 16'><circle r='12' cx='16' cy='16'></circle><circle r='12' cx='16' cy='16' stroke-dashoffset='"+(100-i)/100*h+"' stroke-dasharray='"+h+"'></circle></svg>").append("<span class='"+c.opts.classes.progress+"'>"+Math.round(a.varsAmount/d.varsAmount*100)+"%</span>").append("<span "+c.opts.attr.releaseStatus+"='"+j+"' title='"+c.helper.i18n.get("translation_status_"+j)+"'></span>").appendTo(f)}});var h=b("<select class='"+c.opts.classes.languagesSelect+"' />").appendTo(c.opts.elm.wrapper.overview.children("div"));b("<option value='' />").text("Add language").appendTo(h),Object.keys(g).forEach(function(a){b("<option value='"+a+"' />").text(e[a].label).appendTo(h)})}q(),k()},a.send()},m=function(a,b){var c=!1;return Object.keys(a).some(function(d){if(("Settings"!==d||a[d]/b[d]*100>75)&&b[d]>a[d])return c=!0,!0}),c},n=function b(d,e){var f=new XMLHttpRequest;f.open("POST",c.opts.ajax.langvars,!0),f.onload=function(){var g=JSON.parse(f.responseText);if(g&&Object.getOwnPropertyNames(g).length>0){var h=a({},d,g),i=c.helper.i18n.getDefaultLanguage();d!==i?b(i,function(a){h.default=a[i],"function"==typeof e&&e(h)}):"function"==typeof e&&e(h)}else e(null)};var g=new FormData;g.append("lang",d),f.send(g)},o=function(a){c.opts.elm.wrapper.langvars.data("lang",a),c.opts.elm.wrapper.langvars.find("div."+c.opts.classes.langVarCategory).remove(),c.opts.elm.wrapper.langvars.find("> header > h2").text(""),i("langvars"),j(),n(a,function(d){if(d){var f=d[a],g=0;Object.keys(f).forEach(function(h){var i=b("<div />").addClass(c.opts.classes.langVarCategory).append("<a href='#' />").append("<strong>"+h+"</strong>").appendTo(c.opts.elm.wrapper.langvars.children("div")),j=b("<ul />").appendTo(i),k={total:f[h].length,filled:0};f[h].forEach(function(a,f){a.value&&(k.filled++,g++);var i=b("<li />").append("<label>"+a.label+"</label>").appendTo(j);d.default&&d.default[h]&&d.default[h][f]&&b("<span />").html("<span>"+e[c.helper.i18n.getDefaultLanguage()].label+":</span>"+d.default[h][f].value||"").appendTo(i);var l=a.value||"";b("<textarea />").data({initial:l,name:a.name}).text(l).appendTo(i);0===l.length&&i.addClass(c.opts.classes.empty)}),b("<span />").html("<span>"+k.filled+"</span>/"+k.total).insertBefore(j),e[a].available&&k.filled>0&&k.total>k.filled&&(i.addClass(c.opts.classes.incomplete),i.children("a").attr("title",c.helper.i18n.get("translation_incomplete_info")))}),c.opts.elm.wrapper.langvars.find("> header > h2").text(c.helper.i18n.get("translation_"+(0===g?"add":"edit"))+" ("+e[a].label+")"),r()}else i("overview");k()})},p=function(){c.opts.elm.backToOverview.on("click",function(a){a.preventDefault(),i("overview")}),c.opts.elm.save.on("click",function(a){a.preventDefault();var d=+new Date,e=c.helper.template.loading().appendTo(c.opts.elm.body);c.opts.elm.body.addClass(c.opts.classes.loading);var f={};c.opts.elm.wrapper.langvars.find("textarea").forEach(function(a){var c=a.value;if(c&&c.trim().length>0){var d=b(a).data("initial");if((c=c.trim())!==d){var e=b(a).data("name");f[e]=c}}});var g=new XMLHttpRequest;g.open("POST",c.opts.ajax.submit,!0),g.onload=function(){setTimeout(function(){e.remove(),c.opts.elm.body.attr(c.opts.attr.success,c.helper.i18n.get("translation_submit_message")),c.opts.elm.body.addClass(c.opts.classes.success),setTimeout(function(){c.opts.elm.body.removeClass(c.opts.classes.loading),c.opts.elm.body.removeClass(c.opts.classes.success),location.reload(!0)},1500)},Math.max(0,1e3-(+new Date-d)))};var h=new FormData;h.append("lang",c.opts.elm.wrapper.langvars.data("lang")),h.append("vars",JSON.stringify(f)),g.send(h)})},q=function(){c.opts.elm.wrapper.overview.find("select."+c.opts.classes.languagesSelect).on("change",function(a){o(a.currentTarget.value)}),c.opts.elm.wrapper.overview.find("a."+c.opts.classes.edit).on("click",function(a){a.preventDefault(),o(b(a.currentTarget).parent("li").data("lang"))})},r=function(){c.opts.elm.wrapper.langvars.find("div."+c.opts.classes.langVarCategory+" > a").on("click",function(a){a.preventDefault();var d=b(a.currentTarget).parent();d.toggleClass(c.opts.classes.active),d.hasClass(c.opts.classes.active)&&d.hasClass(c.opts.classes.incomplete)&&(c.opts.elm.wrapper.langvars.children("div")[0].scrollTop=d[0].offsetTop+d.find("li."+c.opts.classes.empty)[0].offsetTop-50)}),c.opts.elm.wrapper.langvars.find("textarea").on("change input",function(a){a.preventDefault();var d=b(a.currentTarget).parents("div."+c.opts.classes.langVarCategory).eq(0),e=0;d.find("textarea").forEach(function(a){a.value&&a.value.trim().length>0&&e++}),d.find("> span > span").text(e)})}},(new window.translation).run()}(jsu);