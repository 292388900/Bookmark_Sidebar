/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";window.translation=function(){let t=null,s={};this.opts={elm:{body:e("body"),title:e("head > title"),header:e("body > header"),content:e("section#content"),backToOverview:e("section#content > a.back"),save:e("section#content > div[data-name='langvars'] > header > button.save"),wrapper:{overview:e("section#content > div[data-name='overview']"),langvars:e("section#content > div[data-name='langvars']"),unavailable:e("section#content > div[data-name='unavailable']")}},classes:{hidden:"hidden",progress:"progress",initLoading:"initLoading",loading:"loading",active:"active",langVarCategory:"category",languagesSelect:"languages",edit:"edit",success:"success",empty:"empty",incomplete:"incomplete",amountInfo:"amountInfo",requiredInfo:"requiredInfo"},attr:{success:"data-successtext",releaseStatus:"data-status"},ajax:{info:"https://extensions.blockbyte.de/ajax/bs/i18n/info",langvars:"https://extensions.blockbyte.de/ajax/bs/i18n/langvars",submit:"https://extensions.blockbyte.de/ajax/bs/i18n/submit"},manifest:chrome.runtime.getManifest()},this.run=(()=>{n("overview"),l(),a(),o(),this.helper.model.init().then(()=>this.helper.i18n.init()).then(()=>(this.helper.font.init(),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["translation"],e(document)),this.helper.template.footer().insertAfter(this.opts.elm.content),this.helper.i18n.parseHtml(document),this.opts.elm.title.text(this.opts.elm.title.text()+" - "+this.helper.i18n.get("extension_name")),i())).then(()=>(this.helper.model.call("trackPageView",{page:"/translation"}),this.opts.elm.body.removeClass(this.opts.classes.initLoading),this.helper.model.call("websiteStatus"))).then(e=>{"available"===e.status?(p(),g()):(n("unavailable"),r())})});let a=()=>{this.helper.template.svgByName("settings/icon-translate").then(e=>{this.opts.elm.header.prepend(e)})},l=()=>{this.helper={template:new window.TemplateHelper(this),i18n:new window.I18nHelper(this),font:new window.FontHelper(this),stylesheet:new window.StylesheetHelper(this),model:new window.ModelHelper(this)}},i=()=>new Promise(e=>{this.helper.model.call("languageInfos").then(t=>{s=t.infos,e()})}),n=e=>{"overview"===e||"unavailable"===e?this.opts.elm.backToOverview.addClass(this.opts.classes.hidden):this.opts.elm.backToOverview.removeClass(this.opts.classes.hidden),Object.keys(this.opts.elm.wrapper).forEach(t=>{t===e?this.opts.elm.wrapper[t].removeClass(this.opts.classes.hidden):this.opts.elm.wrapper[t].addClass(this.opts.classes.hidden)})},o=()=>{Object.keys(this.opts.elm.wrapper).forEach(e=>{!1===this.opts.elm.wrapper[e].hasClass(this.opts.classes.hidden)&&(this.opts.elm.wrapper[e].addClass(this.opts.classes.loading),t=this.helper.template.loading().appendTo(this.opts.elm.wrapper[e]))})},r=(s=300)=>{e.delay(s).then(()=>{t&&t.remove(),Object.keys(this.opts.elm.wrapper).forEach(e=>{!1===this.opts.elm.wrapper[e].hasClass(this.opts.classes.hidden)&&this.opts.elm.wrapper[e].removeClass(this.opts.classes.loading)})})},p=()=>{this.opts.elm.wrapper.overview.find("> div.scrollBox > div > ul").remove(),this.opts.elm.wrapper.overview.find("> div.scrollBox > div > select."+this.opts.classes.languagesSelect).remove(),e.xhr(this.opts.ajax.info).then(t=>{let a=JSON.parse(t.responseText);if(a&&a.languages){let t=e("<ul />").appendTo(this.opts.elm.wrapper.overview.find("> div.scrollBox > div"));a.languages.sort((e,t)=>t.varsAmount!==e.varsAmount?t.varsAmount-e.varsAmount:s[e.name]&&s[t.name]?s[e.name].label>s[t.name].label?1:-1:1);let l=Object.assign({},s);a.languages.forEach(i=>{if(s[i.name]){let n=i.varsAmount/a.varsAmount*100;if(n>10){delete l[i.name];let o=12*Math.PI*2,r="draft";s[i.name].available&&(r=d(i.categories,a.categories)?"incomplete":"released"),e("<li />").data("lang",i.name).append("<strong>"+s[i.name].label+"</strong>").append("<a href='#' class='"+this.opts.classes.edit+"' title='"+this.helper.i18n.get("translation_edit")+"'></a>").append("<svg class="+this.opts.classes.progress+" width='32' height='32' viewPort='0 0 16 16'><circle r='12' cx='16' cy='16'></circle><circle r='12' cx='16' cy='16' stroke-dashoffset='"+(100-n)/100*o+"' stroke-dasharray='"+o+"'></circle></svg>").append("<span class='"+this.opts.classes.progress+"'>"+Math.round(i.varsAmount/a.varsAmount*100)+"%</span>").append("<span "+this.opts.attr.releaseStatus+"='"+r+"' title='"+this.helper.i18n.get("translation_status_"+r)+"'></span>").appendTo(t)}}}),h(l)}u(),r()})},h=t=>{let a=e("<select class='"+this.opts.classes.languagesSelect+"' />").appendTo(this.opts.elm.wrapper.overview.find("> div.scrollBox > div"));e("<option value='' />").text(this.helper.i18n.get("translation_add_language")).appendTo(a);let l=[];Object.keys(t).forEach(t=>{l.push({elm:e("<option value='"+t+"' />").text(s[t].label),label:s[t].label})}),l.sort((e,t)=>e.label>t.label?1:-1),l.forEach(e=>{e.elm.appendTo(a)})},d=(e,t)=>{let s=!1;return Object.keys(e).some(a=>{if(("Settings"!==a||e[a]/t[a]*100>75)&&t[a]>e[a])return s=!0,!0}),s},c=t=>new Promise(s=>{e.xhr(this.opts.ajax.langvars,{method:"POST",data:{lang:t,n:1}}).then(e=>{let a=JSON.parse(e.responseText);if(a&&Object.getOwnPropertyNames(a).length>0){let e={[t]:a},l=this.helper.i18n.getDefaultLanguage();t!==l?c(l).then(t=>{e.default=t[l],s(e)}):s(e)}else s(null)})}),m=t=>{this.opts.elm.wrapper.langvars.data("lang",t),this.opts.elm.wrapper.langvars.find("div."+this.opts.classes.langVarCategory).remove(),this.opts.elm.wrapper.langvars.find("> header > h2").text(""),n("langvars"),o(),c(t).then(a=>{if(a){let l=a[t],i=0;Object.keys(l).forEach(n=>{let o=e("<div />").addClass(this.opts.classes.langVarCategory).append("<a href='#' />").append("<strong>"+n+"</strong>").appendTo(this.opts.elm.wrapper.langvars.find("> div.scrollBox > div")),r=e("<ul />").appendTo(o),p={total:l[n].vars.length,filled:0};l[n].vars.forEach((t,l)=>{t.value&&(p.filled++,i++);let o=e("<li />").append("<label>"+t.label+"</label>").appendTo(r);a.default&&a.default[n]&&a.default[n].vars&&a.default[n].vars[l]&&e("<span />").html("<span>"+s[this.helper.i18n.getDefaultLanguage()].label+":</span>"+a.default[n].vars[l].value||"").appendTo(o);let h=t.value||"";e("<textarea />").data({initial:h,name:t.name}).text(h).appendTo(o);0===h.length&&o.addClass(this.opts.classes.empty)}),l[n].required&&e("<span />").addClass(this.opts.classes.requiredInfo).text("("+this.helper.i18n.get("translation_required_category")+")").insertBefore(r),e("<span />").addClass(this.opts.classes.amountInfo).html("<span>"+p.filled+"</span>&thinsp;/&thinsp;"+p.total).insertBefore(r),s[t].available&&p.filled>0&&p.total>p.filled&&(o.addClass(this.opts.classes.incomplete),o.children("a").attr("title",this.helper.i18n.get("translation_incomplete_info")))}),this.opts.elm.wrapper.langvars.find("> header > h2").text(this.helper.i18n.get("translation_"+(0===i?"add":"edit"))+" ("+s[t].label+")"),f()}else n("overview");r()})},v=()=>{let t=+new Date,s=this.helper.template.loading().appendTo(this.opts.elm.body);this.opts.elm.body.addClass(this.opts.classes.loading);let a={};this.opts.elm.wrapper.langvars.find("textarea").forEach(t=>{let s=t.value;if(s&&s.trim().length>0){let l=e(t).data("initial");if((s=s.trim())!==l){let l=e(t).data("name");a[l]=s}}}),e.xhr(this.opts.ajax.submit,{method:"POST",data:{lang:this.opts.elm.wrapper.langvars.data("lang"),vars:a}}).then(()=>e.delay(Math.max(0,1e3-(+new Date-t)))).then(()=>(s.remove(),this.opts.elm.body.attr(this.opts.attr.success,this.helper.i18n.get("translation_submit_message")),this.opts.elm.body.addClass(this.opts.classes.success),e.delay(1500))).then(()=>{this.opts.elm.body.removeClass(this.opts.classes.loading),this.opts.elm.body.removeClass(this.opts.classes.success),location.reload(!0)})},g=()=>{this.opts.elm.backToOverview.on("click",e=>{e.preventDefault(),n("overview")}),this.opts.elm.save.on("click",e=>{e.preventDefault(),v()})},u=()=>{this.opts.elm.wrapper.overview.find("select."+this.opts.classes.languagesSelect).on("change",e=>{m(e.currentTarget.value)}),this.opts.elm.wrapper.overview.find("a."+this.opts.classes.edit).on("click",t=>{t.preventDefault(),m(e(t.currentTarget).parent("li").data("lang"))})},f=()=>{this.opts.elm.wrapper.langvars.find("div."+this.opts.classes.langVarCategory+" > a").on("click",t=>{t.preventDefault();let s=e(t.currentTarget).parent();s.toggleClass(this.opts.classes.active),s.hasClass(this.opts.classes.active)&&s.hasClass(this.opts.classes.incomplete)&&(this.opts.elm.wrapper.langvars.children("div.scrollBox")[0].scrollTop=s[0].offsetTop+s.find("li."+this.opts.classes.empty)[0].offsetTop-50)}),this.opts.elm.wrapper.langvars.find("textarea").on("change input",t=>{t.preventDefault();let s=e(t.currentTarget).parents("div."+this.opts.classes.langVarCategory).eq(0),a=0;s.find("textarea").forEach(e=>{e.value&&e.value.trim().length>0&&a++}),s.find("> span > span").text(a)})}},(new window.translation).run()})(jsu);