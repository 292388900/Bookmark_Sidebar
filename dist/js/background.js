/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";e.AnalyticsHelper=function(t){let a=!1,n=[],i={config:["configuration"],activity:["installationDate","bookmarks","action"]};this.init=(async()=>{setInterval(()=>{n.length>0&&l()},2e4)}),this.track=(e=>new Promise(t=>{s(e.name,e.value,e.always),t()})),this.trackUserData=(async()=>{let e=t.helper.model.getData("lastTrackDate"),n=+(new Date).setHours(0,0,0,0);try{n=(new Date).toLocaleString("en",{day:"2-digit",month:"2-digit",year:"2-digit",timeZone:"Europe/Berlin"})}catch(e){}!1===a&&e!==n&&(a=!0,t.helper.model.setData("lastTrackDate",n).then(()=>{let e=t.helper.model.getShareInfo(),n="not_set";!0===e.config&&!0===e.activity?n="all":!0===e.config&&!1===e.activity?n="config":!1===e.config&&!0===e.activity?n="activity":!1===e.config&&!1===e.activity&&(n="nothing"),s("version",t.manifest.version_name),s("system",navigator.userAgent),s("language",t.helper.language.getLanguage()),s("shareInfo",n),s("userType",t.helper.model.getUserType()),!0===e.activity&&r(),!0===e.config&&o(),a=!1}))});let r=()=>{let e=t.helper.model.getData("installationDate");e&&s("installationDate",new Date(e).toISOString().slice(0,10)),t.helper.bookmarks.api.getSubTree(0).then(e=>{let t=0,a=e=>{for(let n=0;n<e.length;n++){let i=e[n];i.url?t++:i.children&&a(i.children)}};e&&e[0]&&e[0].children&&e[0].children.length>0&&a(e[0].children),s("bookmarks",t)})},o=()=>{let e=["behaviour","appearance","newtab","language"],t=[],a=(e,n)=>{Object.keys(n).forEach(i=>{"newtab"===e&&"shortcuts"===i?n[i]=n[i].length:"utility"===e&&"pinnedEntries"===i&&"object"==typeof n[i]?n[i]=Object.keys(n[i]).length:"behaviour"!==e||"blacklist"!==i&&"whitelist"!==i||(n[i]=n[i].length),"object"==typeof n[i]?a(e+"_"+i,n[i]):("string"!=typeof n[i]&&(n[i]=JSON.stringify(n[i])),("newtab"===e&&"website"===i||"utility"===e&&"customCss"===i)&&(n[i]=n[i]&&n[i].length>0?"true":"false"),t.push({name:e+"_"+i,value:n[i]}))})};new Promise(t=>{chrome.storage.sync.get(e,n=>{e.forEach(e=>{"newtab"===e&&"object"==typeof n[e]&&void 0!==n[e].override&&!1===n[e].override&&(n[e]={override:!1}),"object"==typeof n[e]&&a(e,n[e])}),t()})}).then(()=>new Promise(e=>{chrome.storage.local.get(["utility"],t=>{if(t.utility){let e={};["lockPinned","pinnedEntries","customCss"].forEach(a=>{void 0!==t.utility[a]&&(e[a]=t.utility[a])}),a("utility",e)}e()})})).then(()=>{s("configuration",t)})},s=(e,a,r=!1)=>{let o=!0;if(!1===r){let a=t.helper.model.getShareInfo();Object.entries(i).some(([t,n])=>{if(n.indexOf(e)>-1)return o=!0===a[t],!0})}!0===o&&!1===t.isDev&&n.push({type:e,value:a})},l=(a={})=>{let i=[];return a&&a.stack&&a.count?i=a.stack:(i=[...n],n=[],a={stack:i,count:0}),new Promise(r=>{console.log(n.length,i,a.count),e.xhr(t.urls.track,{method:"POST",responseType:"json",timeout:1e4,data:{stack:i}}).then(e=>{e.response&&e.response.success?r({success:e.response.success}):r({success:!1})},()=>{a.count<500?e.delay(15e3+500*a.count).then(()=>(a.count++,l(a))).then(r):r({success:!1})})})}},e.Bookmarks=function(e){this.api={},this.init=(()=>new Promise(e=>{["get","getSubTree","removeTree"].forEach(e=>{this.api[e]=(a=>t(e,"object"==typeof a?[a]:[""+a]))}),["update","move"].forEach(e=>{this.api[e]=((a,n)=>t(e,[""+a,n]))}),["create","search"].forEach(e=>{this.api[e]=(a=>t(e,[a]))}),e()}));let t=(t,a)=>new Promise((n,i)=>{chrome.bookmarks[t](...a,a=>{let r=chrome.runtime.lastError;void 0===r?-1!==["update","move","create","removeTree"].indexOf(t)?Promise.all([e.helper.cache.remove({name:"htmlList"}),e.helper.cache.remove({name:"htmlPinnedEntries"})]).then(()=>{n(a)}):n(a):i(r.message)})});this.getById=(e=>new Promise(t=>{this.api.getSubTree(e.id).then(e=>{t({bookmarks:e})})})),this.getBySearchVal=(e=>new Promise(t=>{this.api.search(e.searchVal).then(e=>{t({bookmarks:e})})})),this.update=(t=>new Promise(a=>{new Promise(a=>{let n={title:t.title};t.url&&(n.url=t.url),t.preventReload&&(e.preventReload=!0),this.api.update(t.id,n).then(()=>{a({updated:t.id})},e=>{a({error:e})})}).then(n=>{t.preventReload&&(e.preventReload=!1),a(n)})})),this.create=(t=>new Promise(a=>{new Promise(a=>{let n={parentId:t.parentId,index:t.index||0,title:t.title,url:t.url?t.url:null};t.preventReload&&(e.preventReload=!0),this.api.create(n).then(e=>{a({created:e.id})},e=>{a({error:e})})}).then(n=>{t.preventReload&&(e.preventReload=!1),a(n)})})),this.remove=(t=>new Promise(a=>{new Promise(a=>{t.preventReload&&(e.preventReload=!0),this.api.removeTree(t.id).then(()=>{a({deleted:t.id})},e=>{a({error:e})})}).then(n=>{t.preventReload&&(e.preventReload=!1),a(n)})})),this.move=(e=>new Promise(t=>{let a={parentId:""+e.parentId,index:e.index};this.api.move(e.id,a).then(()=>{t({moved:e.id})})}))},e.BrowserActionHelper=function(e){let t=null,a=null;this.init=(()=>new Promise(e=>{i(),this.initContextmenus(),e()})),this.initContextmenus=(async()=>new Promise(t=>{let a=new Promise(e=>{chrome.storage.sync.get(["behaviour"],t=>{e(t)})});Promise.all([a,e.helper.language.getLangVars()]).then(([a,n])=>{let i=!0;a&&a.behaviour&&void 0!==a.behaviour.contextmenu&&(i=a.behaviour.contextmenu),chrome.contextMenus.removeAll(()=>{let a=Math.random().toString(36).substr(2,12);chrome.contextMenus.create({id:"bsChangelog_"+a,title:n.vars.changelog_title.message,contexts:["browser_action"]}),i&&chrome.contextMenus.create({id:"bsToggle_"+a,title:e.manifest.name,contexts:["page"],documentUrlPatterns:["https://*/*","http://*/*"]}),chrome.contextMenus.onClicked.addListener(e=>{e.menuItemId==="bsChangelog_"+a?chrome.tabs.create({url:chrome.extension.getURL("html/changelog.html")}):e.menuItemId==="bsToggle_"+a&&r()}),t()})})})),this.setReason=(e=>new Promise(t=>{e.reason&&(a=e.reason),t()})),this.clearTimeout=(()=>new Promise(e=>{t&&(clearTimeout(t),t=null),e()}));let n=e=>{let t=null,a=!1,n={new_tab:["chrome://newtab/"],system:["chrome://","about:blank"],extension_page:["chrome-extension://"],webstore:["https?://chrome.google.com/webstore/"]};return Object.keys(n).some(i=>{if(n[i].some(n=>{if(0===e.search(new RegExp(n,"gi")))return t=i,a=!0,!0}),a)return!0}),t},i=async()=>{chrome.browserAction.onClicked.removeListener(r),chrome.browserAction.onClicked.addListener(r)},r=()=>{chrome.tabs.query({active:!0,currentWindow:!0},i=>{chrome.tabs.sendMessage(i[0].id,{action:"toggleSidebar",reinitialized:e.reinitialized});let r=700;if(i[0]&&i[0].url){n(i[0].url)&&(r=0)}t=setTimeout(()=>{(e=>{let t="fallback";if(a)t=a,a=null;else if(e&&e.url){let a=n(e.url);a&&(t=a)}chrome.tabs.create({url:chrome.extension.getURL("html/newtab.html")+"?type="+t})})(i[0])},r)})}},e.CacheHelper=function(e){this.set=(e=>new Promise(t=>{try{chrome.storage.local.set({["cache_"+e.name]:e.val},()=>{t()})}catch(e){t()}})),this.get=(e=>new Promise(t=>{chrome.storage.local.get(["cache_"+e.name],a=>{t({val:a["cache_"+e.name]})})})),this.remove=(t=>new Promise(a=>{e.importRunning?a():chrome.storage.local.remove(["cache_"+t.name],()=>{a()})}))},e.IconHelper=function(t){let a={},n=null;this.init=(()=>new Promise(e=>{Promise.all([i(),t.helper.language.getLangVars()]).then(([a,n])=>{chrome.browserAction.setTitle({title:n.vars.header_bookmarks.message}),"logo"===a.name?chrome.browserAction.setIcon({path:t.manifest.browser_action.default_icon}):this.set({name:a.name,color:a.color}),t.isDev&&(chrome.browserAction.setBadgeBackgroundColor({color:[245,197,37,255]}),chrome.browserAction.setBadgeText({text:"X"})),e()})}));let i=()=>new Promise(e=>{chrome.storage.sync.get(["appearance"],t=>{let a="bookmark",n="#555555";t&&t.appearance&&t.appearance.styles&&(t.appearance.styles.iconShape&&(a=t.appearance.styles.iconShape),t.appearance.styles.iconColor&&(n=t.appearance.styles.iconColor)),e({name:a,color:n})})});this.set=(t=>new Promise(i=>{let r=t.onlyCurrentTab||!1;if(n&&!r&&n===t.name+"_"+t.color)i();else{let o=document.createElement("canvas"),s=128;o.width=s,o.height=s;let l=o.getContext("2d");((t,n)=>new Promise(i=>{new Promise(n=>{a[t]?n(a[t]):e.xhr(chrome.extension.getURL("img/icon/action/icon-"+t+".svg")).then(e=>{let i=e.responseText;a[t]="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(i),n(a[t])})}).then(e=>{n=n.replace(/#/g,"%23"),e=e.replace(/(#|%23)000/g,n),i(e)})}))(t.name,t.color).then(e=>{let a=new Image;a.onload=(()=>{l.drawImage(a,0,0,s,s),chrome.browserAction.setIcon({imageData:l.getImageData(0,0,s,s),tabId:r&&t.tabInfo?t.tabInfo.id:null}),r||(n=t.name+"_"+t.color),i()}),a.src=e})}}))},e.ImageHelper=function(t){let a={},n=!1;this.init=(()=>new Promise(e=>{chrome.storage.local.get(["imageCache"],t=>{a=t.imageCache||{},e()})})),this.getThumbnail=(a=>new Promise(n=>{if(void 0===a.url)n({img:null});else{let o=i("thumb",a.url);o?n({img:o}):e.xhr(t.urls.thumbnail,{method:"POST",timeout:1e4,data:{url:a.url,lang:chrome.i18n.getUILanguage(),ua:navigator.userAgent}}).then(e=>{let t=e.responseText;t&&t.length>0?(r("thumb",a.url,t),n({img:t})):n({img:null})},()=>{n({img:null})})}})),this.getFavicon=(e=>new Promise(t=>{let a=new Image;a.onload=function(){let e=document.createElement("canvas");e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0);let a=e.toDataURL("image/png");t({img:a})},a.src="chrome://favicon/size/16@2x/"+e.url}));let i=(e,t)=>a[e+"_"+t]?a[e+"_"+t].d:null,r=(e,t,i)=>{if(a[e+"_"+t]={t:+new Date,d:i},!1===n){n=!0;let e=+new Date;return Object.keys(a).forEach(t=>{e-a[t].t>2592e5&&delete a[t]}),new Promise(e=>{chrome.storage.local.set({imageCache:a},()=>{n=!1,e()})})}}},e.LanguageHelper=function(t){let a={ar:"Arabic",am:"Amharic",bg:"Bulgarian",bn:"Bengali",ca:"Catalan",cs:"Czech",da:"Danish",de:"German",el:"Greek",en:"English",es:"Spanish",et:"Estonian",fa:"Persian",fi:"Finnish",fil:"Filipino",fr:"French",gu:"Gujarati",he:"Hebrew",hi:"Hindi",hr:"Croatian",hu:"Hungarian",id:"Indonesian",it:"Italian",ja:"Japanese",kn:"Kannada",ko:"Korean",lt:"Lithuanian",lv:"Latvian",ml:"Malayalam",mr:"Marathi",ms:"Malay",nl:"Dutch",no:"Norwegian",pl:"Polish",pt_BR:"Portuguese (Brazil)",pt_PT:"Portuguese (Portugal)",ro:"Romanian",ru:"Russian",sk:"Slovak",sl:"Slovenian",sr:"Serbian",sv:"Swedish",sw:"Swahili",ta:"Tamil",te:"Telugu",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese",zh_CN:"Chinese (Simplified)",zh_TW:"Chinese (Traditional)"},n=["ar","fa","he"],i={pt:"pt_PT"},r=null,o={},s=!1;this.init=(()=>new Promise(e=>{chrome.storage.sync.get(["language"],a=>{let h=t.manifest.default_locale,c=a.language||"default",m=null;"default"===c&&(c=chrome.i18n.getUILanguage()),c=c.replace("-","_"),i[c]&&(c=i[c]),c.indexOf("_")>-1&&(m=c.replace(/_.*$/,"")),this.getAvailableLanguages().then(t=>{[c,m,h].some(a=>{if(null!==a&&t&&t.infos&&t.infos[a]&&t.infos[a].available)return r=a,s=n.indexOf(r)>-1,l(a,h).then(t=>{t&&t.langVars&&(o=t.langVars,e())}),!0})})})})),this.getLanguage=(()=>r),this.getLangVars=(()=>new Promise(e=>{e({language:r,dir:s?"rtl":"ltr",vars:o})})),this.getAvailableLanguages=(()=>new Promise(t=>{chrome.storage.local.get(["languageInfos"],n=>{if(n&&n.languageInfos&&(+new Date-n.languageInfos.updated)/36e5<8)t({infos:n.languageInfos.infos});else{let n=Object.keys(a).length,i=0,r={};Object.keys(a).forEach(o=>{r[o]={name:o,label:a[o],available:!1};let s=()=>{++i===n&&(chrome.storage.local.set({languageInfos:{infos:r,updated:+new Date}}),t({infos:r}))};e.xhr(chrome.extension.getURL("_locales/"+o+"/messages.json"),{method:"HEAD"}).then(()=>{r[o].available=!0,s()},s)})}})}));let l=(t,a=null)=>new Promise(n=>{if(t){let i=a=>{let i=a.langVars;e.xhr(chrome.extension.getURL("_locales/"+t+"/messages.json")).then(e=>{let t=JSON.parse(e.responseText);Object.assign(i,t),n({langVars:i})})};a&&a!==t?l(a,null).then(i):i({langVars:{}})}})},e.ModelHelper=function(e){let t={},a=null,n={config:null,activity:null};this.init=(()=>new Promise(e=>{chrome.storage.sync.get(["model","shareInfo","licenseKey"],r=>{t=r.model||{},"object"==typeof r.shareInfo&&(n=r.shareInfo),"string"==typeof r.licenseKey&&29===r.licenseKey.length&&(a=r.licenseKey),void 0===t.installationDate&&(t.installationDate=+new Date),void 0===t.premiumInfo&&(t.premiumInfo=null),i().then(e)})})),this.getShareInfo=(()=>n),this.getLicenseKey=(()=>a),this.getInfoToDisplay=(()=>new Promise(e=>{if(t&&t.installationDate){let a=(+new Date-t.installationDate)/864e5;null===n.config&&null===n.activity&&a>7?e({info:"shareInfo"}):this.getUserType().then(n=>{let i=null===t.premiumInfo?365:(+new Date-t.premiumInfo)/864e5;"premium"!==n.userType&&i>200&&a>14?this.setData("premiumInfo",+new Date).then(()=>{e({info:"premium"})}):e({info:null})})}else e({info:null})})),this.getUserType=(()=>new Promise(e=>{let n="default";"string"==typeof a&&29===a.length?n="premium":t&&t.installationDate&&t.installationDate<1538352e6&&(n="legacy"),e({userType:n})})),this.setShareInfo=(e=>new Promise(t=>{n={config:e.config||!1,activity:e.activity||!1},chrome.storage.sync.set({shareInfo:n},()=>{chrome.runtime.lastError,t()})})),this.setLicenseKey=(e=>new Promise(t=>{chrome.storage.sync.set({licenseKey:e},()=>{chrome.runtime.lastError,a=e,t()})})),this.setData=((e,a)=>new Promise(n=>{t[e]=a,i().then(n)})),this.getData=(e=>t[e]||null);let i=()=>new Promise(e=>{Object.getOwnPropertyNames(t).length>0&&chrome.storage.sync.set({model:t},()=>{chrome.runtime.lastError,e()})})},e.NewtabHelper=function(e){let t={};this.init=(()=>new Promise(e=>{this.updateConfig().then(()=>{a(),e()})})),this.updateConfig=(()=>new Promise(e=>{chrome.storage.sync.get(["newtab"],a=>{t=void 0===a.newtab?{}:a.newtab,e()})}));let a=async()=>{chrome.tabs.onCreated.addListener(e=>{if(e.url&&"chrome://newtab/"===e.url&&void 0!==t.override&&!0===t.override){let a="create";0===e.index?a="update":chrome.tabs.remove(e.id),t.website&&t.website.length>0?i(a):n(a)}})},n=e=>{chrome.tabs[e]({url:chrome.extension.getURL("html/newtab.html"),active:!0})},i=e=>{chrome.tabs[e]({url:r(t.website,"bs_nt",1),active:!0})},r=(e,t,a)=>{let n=new RegExp("([?&])"+t+"=.*?(&|#|$)","i");if(e.match(n))return e.replace(n,"$1"+t+"="+a+"$2");{let n="";return-1!==e.indexOf("#")&&(n=e.replace(/.*#/,"#"),e=e.replace(/#.*/,"")),e+(-1!==e.indexOf("?")?"&":"?")+t+"="+a+n}}},e.PortHelper=function(t){let a=()=>new Promise(a=>{e.xhr(t.urls.checkStatus,{method:"POST",responseType:"json",data:{version:t.isDev?"9.9.9":t.manifest.version}}).then(e=>{e.response&&e.response.available?a({status:"available"}):a({status:"unavailable"})},()=>{a({status:"unavailable"})})}),n=a=>new Promise(n=>{a.abort&&!0===a.abort?e.cancelXhr(t.urls.checkUrls):Promise.all([e.xhr(t.urls.checkUrls,{method:"POST",data:{urlList:a.urls,ua:navigator.userAgent,lang:chrome.i18n.getUILanguage()}}),i(a.urls)]).then(([e,t])=>{let a=JSON.parse(e.responseText);n({xhr:a,duplicates:t})},()=>{n({error:!0})})}),i=async e=>{let a={},n=Object.values(e),i=e=>e=(e=(e=(e=e.split("?")[0]).split("#")[0]).replace(/^https?:\/\//,"")).replace(/^www\./,"");for(const e of n){let n=i(e),r=await t.helper.bookmarks.api.search(n);if(r.length>1){let t=[];r.forEach(e=>{i(e.url)===n&&t.push(e)}),t.length>1&&(a[n]={url:e,duplicates:t})}}return a},r=e=>new Promise(a=>{if(t.helper.viewAmount.addByEntry(e),e.newTab&&!0===e.newTab){let n=(n=null)=>{chrome.tabs.query({active:!0,currentWindow:!0},i=>{chrome.tabs.create({url:e.href,active:void 0===e.active||!!e.active,index:null===n?i[0].index+1:n,openerTabId:i[0].id},e=>{t.helper.model.setData("openedByExtension",e.id).then(a)})})};"afterLast"===e.position?chrome.tabs.query({currentWindow:!0},e=>{let t=0;e.forEach(e=>{t=Math.max(t,e.index)}),n(t+1)}):"beforeFirst"===e.position?n(0):n()}else e.newWindow&&!0===e.newWindow?(chrome.windows.create({url:e.href,state:"maximized"}),a()):e.incognito&&!0===e.incognito?(chrome.windows.create({url:e.href,state:"maximized",incognito:!0}),a()):chrome.tabs.query({active:!0,currentWindow:!0},n=>{chrome.tabs.update(n[0].id,{url:e.href},e=>{t.helper.model.setData("openedByExtension",e.id).then(a)})})});this.init=(()=>new Promise(e=>{let i=0,o={checkUrls:n,bookmarks:t.helper.bookmarks.getById,searchBookmarks:t.helper.bookmarks.getBySearchVal,moveBookmark:t.helper.bookmarks.move,updateBookmark:t.helper.bookmarks.update,createBookmark:t.helper.bookmarks.create,deleteBookmark:t.helper.bookmarks.remove,reload:t.reload,reinitialize:t.reinitialize,updateShareInfo:t.helper.model.setShareInfo,infoToDisplay:t.helper.model.getInfoToDisplay,languageInfos:t.helper.language.getAvailableLanguages,langvars:t.helper.language.getLangVars,favicon:t.helper.image.getFavicon,thumbnail:t.helper.image.getThumbnail,openLink:r,userType:t.helper.model.getUserType,activatePremium:t.activatePremium,getCache:t.helper.cache.get,setCache:t.helper.cache.set,removeCache:t.helper.cache.remove,websiteStatus:a,track:t.helper.analytics.track,updateIcon:t.helper.icon.set,reloadIcon:t.helper.icon.init,reloadContextmenus:t.helper.browserAction.initContextmenus,clearNotWorkingTimeout:t.helper.browserAction.clearTimeout,setNotWorkingReason:t.helper.browserAction.setReason,addViewAmount:t.helper.viewAmount.addByUrl,viewAmounts:t.helper.viewAmount.getAll};chrome.runtime.onConnect.addListener(e=>{e.name&&"background"===e.name&&e.onMessage.addListener((a,n)=>{o[a.type]&&(70===i&&(t.helper.analytics.trackUserData(),i%=70),a.tabInfo=n.sender.tab,o[a.type](a).then(t=>{try{e.postMessage({uid:a.uid,result:t})}catch(e){}}),i++)})}),e()}))},e.UpgradeHelper=function(e){this.loaded=!1,this.init=(async()=>{chrome.runtime.onUpdateAvailable.addListener(()=>{chrome.runtime.reload()}),this.loaded=!0}),this.onInstalled=(()=>{let t=e.helper.model.getData("installationDate");(null===t||+new Date-t<6e4)&&(e.helper.analytics.track({name:"action",value:{name:"install",value:1},always:!0}),chrome.tabs.create({url:chrome.extension.getURL("html/intro.html")})),e.reinitialize()}),this.onUpdated=(a=>{chrome.storage.local.remove(["languageInfos"]);let n=e.manifest.version,i=a.previousVersion.split("."),r=n.split(".");i[0]!==r[0]||i[1]!==r[1]?t().then(()=>{e.reinitialize()}):e.reinitialize()});let t=()=>new Promise(e=>{let t=0,a=()=>{++t>=3&&e()};chrome.storage.sync.get(null,e=>{void 0===e.behaviour&&(e.behaviour={}),void 0===e.appearance&&(e.appearance={}),void 0===e.newtab&&(e.newtab={});try{delete e.behaviour.initialOpenOnNewTab,delete e.behaviour.rememberSearch,delete e.behaviour.autoOpen,delete e.behaviour.pxTolerance,delete e.behaviour.scrollSensitivity,delete e.behaviour.hideEmptyDirs,delete e.behaviour.replaceNewTab,delete e.behaviour.language,delete e.appearance.language,delete e.appearance.sidebarPosition,delete e.newtab.initialOpen}catch(e){}chrome.storage.sync.set({behaviour:e.behaviour},a),chrome.storage.sync.set({newtab:e.newtab},a),chrome.storage.sync.set({appearance:e.appearance},a)})})},e.ViewAmountHelper=function(e){this.getAll=(()=>new Promise(a=>{t().then(t=>{a({viewAmounts:t,counterStartDate:e.helper.model.getData("installationDate")})})})),this.addByUrl=(t=>new Promise(a=>{null===e.helper.model.getData("openedByExtension")&&e.helper.bookmarks.api.search({url:t.url}).then(e=>{e.some(e=>e.url===t.url&&(this.addByEntry(e),!0)),a()}),e.helper.model.setData("openedByExtension",null)})),this.addByEntry=(e=>{e.id&&t().then(t=>{void 0!==t[e.id]&&"object"==typeof t[e.id]||(t[e.id]={c:0}),t[e.id].c++,t[e.id].d=+new Date,chrome.storage.local.set({clickCounter:t})})});let t=()=>new Promise(e=>{chrome.storage.local.get(["clickCounter"],t=>{let a={};void 0!==t.clickCounter&&(a=t.clickCounter),e(a)})})};(new function(){this.importRunning=!1,this.preventReload=!1,this.manifest=chrome.runtime.getManifest(),this.urls={website:"https://extensions.blockbyte.de/",checkStatus:"https://extensions.blockbyte.de/ajax/status/bs",track:"https://extensions.blockbyte.de/ajax/evaluate/bs",premiumCheck:"https://extensions.blockbyte.de/ajax/premium/check/bs",uninstall:"https://extensions.blockbyte.de/uninstall/bs",checkUrls:"https://4v1.de/u",thumbnail:"https://4v1.de/t"},this.isDev=!1,this.reinitialized=null,this.reload=(t=>new Promise(a=>{Promise.all([this.helper.newtab.updateConfig(),this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})]).then(()=>{chrome.tabs.query({},n=>{n.forEach((a,n)=>{let i=a.active?0:100*n;e.delay(i).then(()=>{chrome.tabs.sendMessage(a.id,{action:"reload",scrollTop:t.scrollTop||!1,reinitialized:this.reinitialized,type:t.type})})}),a()})})})),this.reinitialize=(()=>new Promise(t=>{this.reinitialized=+new Date;let n={css:"insertCSS",js:"executeScript"};Promise.all([this.helper.newtab.updateConfig(),this.helper.language.init(),this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})]).then(()=>{chrome.tabs.query({},i=>{i.forEach((t,i)=>{if(void 0===t.url||!t.url.startsWith("chrome://")&&!t.url.startsWith("chrome-extension://")){let r=t.active?0:100*i;e.delay(r).then(()=>{Object.entries(n).forEach(([e,n])=>{let i=this.manifest.content_scripts[0][e],r=!1;i.forEach(e=>{chrome.tabs[n](t.id,{file:e},()=>{let e=chrome.runtime.lastError;e&&e.message&&!1===r&&(r=!0,a(t.id))})})})})}else a(t.id)}),t()})})})),this.activatePremium=(e=>new Promise(a=>{t(e.licenseKey).then(t=>{!0===t.valid?this.helper.model.setLicenseKey(e.licenseKey).then(()=>{this.reinitialize()}).then(()=>{a({success:!0})}):a({success:!1})})}));let t=t=>new Promise(a=>{e.xhr(this.urls.premiumCheck,{method:"POST",responseType:"json",data:{licenseKey:t}}).then(e=>{e.response&&void 0!==e.response.valid?a({valid:e.response.valid}):a({valid:null})},()=>{a({valid:null})})}),a=e=>{chrome.tabs.sendMessage(e,{action:"reinitialize"})},n=async()=>{chrome.bookmarks.onImportBegan.addListener(()=>{this.importRunning=!0}),chrome.bookmarks.onImportEnded.addListener(()=>{this.importRunning=!1,e.delay(1e3).then(()=>{this.reload({type:"Created"})})}),["Changed","Created","Removed"].forEach(e=>{chrome.bookmarks["on"+e].addListener(()=>{!1===this.importRunning&&!1===this.preventReload&&this.reload({type:e})})}),["Moved","ChildrenReordered"].forEach(e=>{chrome.bookmarks["on"+e].addListener(()=>{Promise.all([this.helper.cache.remove({name:"htmlList"}),this.helper.cache.remove({name:"htmlPinnedEntries"})])})})},i=()=>{this.helper={model:new e.ModelHelper(this),bookmarks:new e.Bookmarks(this),language:new e.LanguageHelper(this),upgrade:new e.UpgradeHelper(this),viewAmount:new e.ViewAmountHelper(this),newtab:new e.NewtabHelper(this),image:new e.ImageHelper(this),port:new e.PortHelper(this),icon:new e.IconHelper(this),browserAction:new e.BrowserActionHelper(this),cache:new e.CacheHelper(this),analytics:new e.AnalyticsHelper(this)}},r=(t,a=0)=>{this.helper&&this.helper.upgrade&&this.helper.upgrade.loaded?"install"===t.reason?this.helper.upgrade.onInstalled(t):"update"===t.reason&&this.helper.upgrade.onUpdated(t):a<100&&e.delay(500).then(()=>{r(t,a+1)})};this.run=(()=>{let e=+new Date;this.isDev="Dev"===this.manifest.version_name||!("update_url"in this.manifest),chrome.runtime.onInstalled.addListener(e=>{r(e)}),chrome.runtime.setUninstallURL(this.urls[this.isDev?"website":"uninstall"]),i(),Promise.all([this.helper.model.init(),this.helper.language.init(),this.helper.analytics.init(),this.helper.bookmarks.init()]).then(()=>this.helper.icon.init()).then(()=>Promise.all([n(),this.helper.browserAction.init(),this.helper.newtab.init(),this.helper.image.init(),this.helper.port.init(),this.helper.upgrade.init()])).then(()=>this.helper.analytics.trackUserData()).then(()=>{let a=this.helper.model.getLicenseKey(),n=Math.floor(20*Math.random())+1;a&&1===n&&t(a).then(e=>{!1===e.valid&&this.helper.model.setLicenseKey(null)}),this.isDev&&console&&console.log&&console.info("Finished loading background script",+new Date-e)})})}).run()})(jsu);