/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";window.AnalyticsHelper=function(t){let a=[],i=!1,n={dev:"100595538-3",live:"100595538-2"};this.init=(()=>new Promise(t=>{window.GoogleAnalyticsObject="ga",window.ga=window.ga||function(){(window.ga.q=window.ga.q||[]).push(arguments)},window.ga.l=+new Date;let a=document.createElement("script");a.async=1,a.src="https://www.google-analytics.com/analytics.js";let i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(a,i);let r=e.api.runtime.getManifest();window.ga("create","UA-"+n["Dev"!==r.version_name&&"update_url"in r?"live":"dev"],"auto"),window.ga("set","checkProtocolTask",null),window.ga("set","transport","beacon"),t()})),this.trackEvent=(e=>new Promise(t=>{r({hitType:"event",eventCategory:e.category,eventAction:e.action,eventLabel:e.label,eventValue:e.value||1},e.always||!1),t()})),this.trackPageView=(e=>new Promise(t=>{r({hitType:"pageview",page:e.page},e.always||!1),t()})),this.trackUserData=(()=>{let a=e.api.runtime.getManifest(),i="not_set",n=t.helper.model.shareUserdata();if(!0===n?i="allowed":!1===n&&(i="not_allowed"),this.trackEvent({category:"extension",action:"user",label:"share_"+i,always:!0}),this.trackEvent({category:"extension",action:"version",label:a.version,always:!0}),!0===n){let a=t.helper.model.getData("installationDate");a&&this.trackEvent({category:"extension",action:"installationDate",label:new Date(a).toISOString().slice(0,10)}),t.helper.bookmarkApi.func.getSubTree(0).then(e=>{let t=0,a=e=>{for(let i=0;i<e.length;i++){let n=e[i];n.url?t++:n.children&&a(n.children)}};e&&e[0]&&e[0].children&&e[0].children.length>0&&a(e[0].children),this.trackEvent({category:"extension",action:"bookmarks",label:"amount",value:t})});let i=["behaviour","appearance"],n=(e,t)=>{Object.keys(t).forEach(a=>{"object"==typeof t[a]?n(e+"_"+a,t[a]):("string"!=typeof t[a]&&(t[a]=JSON.stringify(t[a])),this.trackEvent({category:"configuration",action:e+"_"+a,label:t[a]}))})};e.api.storage.sync.get(i,e=>{i.forEach(t=>{"object"==typeof e[t]&&n(t,e[t])})})}});let r=(e,n)=>{!0!==t.helper.model.shareUserdata()&&!0!==n||(a.push(e),!1===i&&o())},o=()=>{i=!0,e.delay(1e3).then(()=>{if(a.length>0&&window.ga&&window.ga.loaded){let e=a.shift();window.ga("send",e),o()}else i=!1})}},window.BookmarkApi=function(t){this.func={},this.init=(()=>new Promise(e=>{["get","getSubTree","removeTree"].forEach(e=>{this.func[e]=(t=>a(e,[""+t]))}),["update","move"].forEach(e=>{this.func[e]=((t,i)=>a(e,[""+t,i]))}),["create","search"].forEach(e=>{this.func[e]=(t=>a(e,[t]))}),e()}));let a=(a,i)=>new Promise((n,r)=>{e.api.bookmarks[a](...i,i=>{let o=e.api.runtime.lastError;void 0===o?-1!==["update","move","create","removeTree"].indexOf(a)?Promise.all([t.helper.cache.remove({name:"html"}),t.helper.entries.update()]).then(()=>{n(i)}):n(i):r(o.message)})})},window.CacheHelper=function(t){this.set=(t=>new Promise(a=>{try{e.api.storage.local.set({["cache_"+t.name]:t.val},()=>{a()})}catch(e){a()}})),this.get=(t=>new Promise(a=>{e.api.storage.local.get(["cache_"+t.name],e=>{a({val:e["cache_"+t.name]})})})),this.remove=(t=>new Promise(a=>{e.api.storage.local.remove(["cache_"+t.name],()=>{a()})}))},window.EntriesHelper=function(t){let a={},i={},n={},r={},o=[],s=[];this.update=(()=>new Promise(d=>{Promise.all([t.helper.bookmarkApi.func.getSubTree(0),t.helper.viewAmount.getAll()]).then(t=>{r=t[1];let c=[];t[0]&&t[0][0]&&t[0][0].children&&(c=t[0][0].children),e.api.storage.local.get(["utility"],e=>{o=e.utility?e.utility.hiddenEntries||[]:[],s=e.utility?e.utility.pinnedEntries||[]:[],i={bookmarks:{},directories:{},pinned:{}},n={bookmarks:{visible:0,hidden:0},directories:{visible:0,hidden:0},pinned:{visible:0,hidden:0}},l(c),a={entries:i,amounts:n},d()})})})),this.getEntries=(()=>new Promise(e=>{e(a)}));let l=(e,t=[],a=!1)=>{e.forEach(e=>{let i=[...t];"0"!==e.parentId&&i.push(e.parentId),e.hidden=a||!0===o[e.id],e.parents=i,e.views={startDate:+new Date(Math.max(e.dateAdded,r.counterStartDate)),total:0},e.url?c(e):e.children&&d(e)})},d=e=>{e.childrenAmount={bookmarks:0,directories:0,total:0},e.parents.forEach(e=>{i.directories[e].childrenAmount.directories++}),i.directories[e.id]=e,l(e.children,e.parents,e.hidden),e.isDir=!0,e.childrenAmount.total=e.childrenAmount.bookmarks+e.childrenAmount.directories,e.views.perMonth=Math.round(e.views.total/h(e.views.startDate)*100)/100,n.directories[e.hidden?"hidden":"visible"]++},c=e=>{let t=0,a=0;if(r.viewAmounts[e.id]&&(t=r.viewAmounts[e.id].c,a=r.viewAmounts[e.id].d||0),e.views.total=t,e.views.lastView=a,e.views.perMonth=Math.round(t/h(e.views.startDate)*100)/100,e.parents.forEach(e=>{i.directories[e]&&(i.directories[e].childrenAmount.bookmarks++,i.directories[e].views.total+=t,i.directories[e].views.lastView=Math.max(i.directories[e].views.lastView||0,a))}),e.pinned=!1,i.bookmarks[e.id]=e,n.bookmarks[e.hidden?"hidden":"visible"]++,s[e.id]){e.pinned=!0;let t=Object.assign({},e);t.index=s[e.id].index,delete t.parents,delete t.parentId,i.pinned[e.id]=t,n.pinned[e.hidden?"hidden":"visible"]++}},h=e=>Math.max(1,Math.round((+new Date-e)/2627999942.4))},window.IconHelper=function(t){let a={},i=null;this.init=(()=>new Promise(t=>{e.api.storage.sync.get(["appearance"],e=>{let a="bookmark",i="rgb(85,85,85)";e&&e.appearance&&e.appearance.styles&&(e.appearance.styles.iconShape&&(a=e.appearance.styles.iconShape),e.appearance.styles.iconColor&&(i=e.appearance.styles.iconColor)),"logo"!==a&&this.set({name:a,color:i}),t()})})),this.set=(t=>new Promise(n=>{let r=t.onlyCurrentTab||!1;if(i&&!r&&i===t.name+"_"+t.color)n();else{let o=document.createElement("canvas");o.width=128,o.height=128;let s=o.getContext("2d");new Promise(i=>{a[t.name]?i(a[t.name]):e.xhr(e.api.extension.getURL("img/icon/menu/icon-"+t.name+".svg")).then(e=>{let n=e.responseText;a[t.name]="data:image/svg+xml;charset=utf-8,"+n,i(a[t.name])})}).then(a=>{a=a.replace(/\#000/g,t.color);let o=new Image;o.onload=(()=>{s.drawImage(o,0,0,128,128),e.api.browserAction.setIcon({imageData:s.getImageData(0,0,128,128),tabId:r&&t.tabInfo?t.tabInfo.id:null}),r||(i=t.name+"_"+t.color),n()}),o.src=a})}}))},window.LanguageHelper=function(t){let a={af:"Afrikaans",ar:"Arabic",hy:"Armenian",be:"Belarusian",bg:"Bulgarian",ca:"Catalan","zh-CN":"Chinese (Simplified)","zh-TW":"Chinese (Traditional)",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch",en:"English",eo:"Esperanto",et:"Estonian",tl:"Filipino",fi:"Finnish",fr:"French",de:"German",el:"Greek",iw:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",it:"Italian",ja:"Japanese",ko:"Korean",lv:"Latvian",lt:"Lithuanian",no:"Norwegian",fa:"Persian",pl:"Polish",pt:"Portuguese",ro:"Romanian",ru:"Russian",sr:"Serbian",sk:"Slovak",sl:"Slovenian",es:"Spanish",sw:"Swahili",sv:"Swedish",ta:"Tamil",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese"},i={};this.getAll=(()=>new Promise(e=>{n().then(t=>{e({infos:t})})})),this.getVars=(t=>new Promise(a=>{if(t.lang){let n=void 0===t.cache||!0===t.cache;if(i[t.lang]&&n)a({langVars:i[t.lang]});else{let r=r=>{let o=r.langVars;e.xhr(e.api.extension.getURL("_locales/"+t.lang+"/messages.json")).then(e=>{let r=JSON.parse(e.responseText);Object.assign(o,r),n&&(i[t.lang]=o),a({langVars:o})})};t.defaultLang&&t.defaultLang!==t.lang?this.getVars({lang:t.defaultLang,cache:!1}).then(r):r({langVars:{}})}}}));let n=()=>new Promise(t=>{e.api.storage.local.get(["languageInfos"],i=>{if(i&&i.languageInfos&&(+new Date-i.languageInfos.updated)/36e5<8)t(i.languageInfos.infos);else{let i=Object.keys(a).length,n=0,r={};Object.keys(a).forEach(o=>{r[o]={name:o,label:a[o],available:!1};let s=()=>{++n===i&&(e.api.storage.local.set({languageInfos:{infos:r,updated:+new Date}}),t(r))};e.xhr(e.api.extension.getURL("_locales/"+o+"/messages.json"),{method:"HEAD"}).then(()=>{r[o].available=!0,s()},s)})}})})},window.ModelHelper=function(t){let a=null,i={};this.init=(()=>new Promise(r=>{e.api.storage.sync.get(["model","shareUserdata"],e=>{i=e.model||{},a=void 0===e.shareUserdata?null:e.shareUserdata,void 0===i.installationDate&&(i.installationDate=+new Date);let o=+(new Date).setHours(0,0,0,0);void 0!==i.lastTrackDate&&i.lastTrackDate===o||(i.lastTrackDate=o,t.helper.analytics.trackUserData()),n().then(r)})})),this.shareUserdata=(()=>a),this.setData=((e,t)=>new Promise(a=>{i[e]=t,n().then(a)})),this.getData=(e=>i[e]||null);let n=()=>new Promise(t=>{Object.getOwnPropertyNames(i).length>0&&e.api.storage.sync.set({model:i},()=>{t()})})},window.NewtabHelper=function(t){let a={};this.init=(()=>new Promise(e=>{this.updateConfig().then(()=>{i(),e()})})),this.updateConfig=(()=>new Promise(t=>{e.api.storage.sync.get(["newtab"],e=>{a=void 0===e.newtab?{}:e.newtab,t()})}));let i=async()=>{e.api.tabs.onCreated.addListener(t=>{if(t.url&&"chrome://newtab/"===t.url&&void 0!==a.override&&!0===a.override){let i="create";0===t.index?i="update":e.api.tabs.remove(t.id),a.website&&a.website.length>0?r(i):n(i)}})},n=t=>{e.api.tabs[t]({url:e.api.extension.getURL("html/newtab.html"),active:!0})},r=t=>{e.api.tabs[t]({url:o(a.website,"bs_nt",1),active:!0})},o=(e,t,a)=>{let i=new RegExp("([?&])"+t+"=.*?(&|#|$)","i");if(e.match(i))return e.replace(i,"$1"+t+"="+a+"$2");{let i="";return-1!==e.indexOf("#")&&(i=e.replace(/.*#/,"#"),e=e.replace(/#.*/,"")),e+(-1!==e.indexOf("?")?"&":"?")+t+"="+a+i}}},window.PortHelper=function(t){let a=a=>new Promise(i=>{e.api.storage.sync.set({shareUserdata:a.share},()=>{t.helper.model.init().then(i)})}),i=()=>new Promise(a=>{e.xhr(t.urls.check404,{method:"HEAD",timeout:5e3}).then(()=>{a({status:"available"})},()=>{a({status:"unavailable"})})}),n=()=>new Promise(e=>{let a=!1,i=t.helper.model.getData("installationDate");null===t.helper.model.shareUserdata()&&(+new Date-i)/864e5>5&&(a=!0),e({showMask:a})}),r=a=>new Promise(i=>{a.abort&&!0===a.abort?e.cancelXhr(t.urls.updateUrls):e.xhr(t.urls.updateUrls,{method:"POST",data:{urlList:a.urls,ua:navigator.userAgent,lang:e.api.i18n.getUILanguage()}}).then(e=>{let t=JSON.parse(e.responseText);i(t)},()=>{i({error:!0})})}),o=e=>new Promise(a=>{let i={title:e.title};e.url&&(i.url=e.url),t.helper.bookmarkApi.func.update(e.id,i).then(()=>{a({updated:e.id})},e=>{a({error:e})})}),s=e=>new Promise(a=>{let i={parentId:e.parentId,index:e.index||0,title:e.title,url:e.url?e.url:null};t.helper.bookmarkApi.func.create(i).then(()=>{a({created:e.id})},e=>{a({error:e})})}),l=e=>new Promise(a=>{t.helper.bookmarkApi.func.removeTree(e.id).then(()=>{a({deleted:e.id})})}),d=e=>new Promise(a=>{let i={parentId:""+e.parentId,index:e.index};t.helper.bookmarkApi.func.move(e.id,i).then(()=>{a({moved:e.id})})}),c=e=>new Promise(a=>{t.helper.bookmarkApi.func.getSubTree(e.id).then(e=>{a({bookmarks:e})})}),h=e=>new Promise(a=>{t.helper.bookmarkApi.func.search(e.searchVal).then(e=>{a({bookmarks:e})})}),p=a=>new Promise(i=>{if(t.helper.viewAmount.addByEntry(a),a.newTab&&!0===a.newTab){let n=(n=null)=>{e.api.tabs.query({active:!0,currentWindow:!0},r=>{e.api.tabs.create({url:a.href,active:void 0===a.active||!!a.active,index:null===n?r[0].index+1:n,openerTabId:r[0].id},e=>{t.helper.model.setData("openedByExtension",e.id).then(i)})})};"afterLast"===a.position?e.api.tabs.query({},e=>{n(e[e.length-1].index+1)}):"beforeFirst"===a.position?n(0):n()}else a.incognito&&!0===a.incognito?(e.api.windows.create({url:a.href,state:"maximized",incognito:!0}),i()):e.api.tabs.query({active:!0,currentWindow:!0},n=>{e.api.tabs.update(n[0].id,{url:a.href},e=>{t.helper.model.setData("openedByExtension",e.id).then(i)})})}),u=e=>new Promise(t=>{let a=new Image;a.onload=function(){let e=document.createElement("canvas");e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0);let a=e.toDataURL("image/png");t({img:a})},a.src="chrome://favicon/size/16@2x/"+e.url});this.init=(()=>new Promise(m=>{let w={checkUrls:r,bookmarks:c,searchBookmarks:h,moveBookmark:d,updateBookmark:o,createBookmark:s,deleteBookmark:l,refreshAllTabs:t.refreshAllTabs,shareUserdata:a,shareUserdataMask:n,languageInfos:t.helper.language.getAll,langvars:t.helper.language.getVars,favicon:u,openLink:p,getCache:t.helper.cache.get,setCache:t.helper.cache.set,removeCache:t.helper.cache.remove,websiteStatus:i,trackPageView:t.helper.analytics.trackPageView,trackEvent:t.helper.analytics.trackEvent,updateIcon:t.helper.icon.set,reloadIcon:t.helper.icon.init,addViewAmount:t.helper.viewAmount.addByUrl,viewAmounts:t.helper.viewAmount.getAll,updateEntries:t.helper.entries.update,entries:t.helper.entries.getEntries};e.api.runtime.onConnect.addListener(e=>{e.name&&"background"===e.name&&e.onMessage.addListener((t,a)=>{w[t.type]&&(t.tabInfo=a.sender.tab,w[t.type](t).then(a=>{e.postMessage({uid:t.uid,result:a})}))})}),m()}))},window.UpdatesHelper=function(t){this.init=(()=>new Promise(e=>{a(),e()}));let a=()=>{e.api.runtime.onUpdateAvailable.addListener(()=>{e.api.runtime.reload()}),e.api.runtime.onInstalled.addListener(a=>{if("install"===a.reason)e.api.tabs.create({url:e.api.extension.getURL("html/intro.html")});else if("update"===a.reason){e.api.storage.local.remove(["languageInfos"]);let n=e.api.runtime.getManifest().version;a.previousVersion!==n&&t.helper.analytics.trackEvent({category:"extension",action:"update",label:a.previousVersion+" -> "+n},!0);let r=a.previousVersion.split("."),o=n.split(".");r[0]===o[0]&&r[1]===o[1]||i(n)}})},i=a=>{e.api.storage.sync.get(["model"],i=>{void 0===i.model||void 0!==i.model.updateNotification&&i.model.updateNotification===a||t.helper.model.setData("updateNotification",a).then(()=>{e.api.tabs.create({url:e.api.extension.getURL("html/changelog.html")})})}),e.api.storage.sync.get(null,t=>{void 0===t.behaviour&&(t.behaviour={}),void 0===t.appearance&&(t.appearance={}),void 0===t.newtab&&(t.newtab={}),e.api.storage.sync.remove(["utility","nt_notice"]),["sidebarPosition","language"].forEach(e=>{void 0===t.behaviour[e]&&void 0!==t.appearance[e]&&(t.behaviour[e]=t.appearance[e]),delete t.appearance[e]}),void 0!==t.behaviour.initialOpenOnNewTab&&(t.newtab.initialOpen=t.behaviour.initialOpenOnNewTab),void 0!==t.behaviour.replaceNewTab&&(t.newtab.override=t.behaviour.replaceNewTab),void 0!==t.behaviour.rememberState&&"all"===t.behaviour.rememberState&&(t.behaviour.rememberState="openStatesAndPos"),void 0===t.appearance.iconShape&&(t.appearance.iconShape="logo"),void 0!==t.utility&&e.api.storage.local.set({utility:t.utility}),delete t.behaviour.scrollSensitivity,void 0===t.appearance.styles&&(t.appearance.styles={}),void 0!==t.appearance.styles.fontFamily&&"Roboto"===t.appearance.styles.fontFamily&&(t.appearance.styles.fontFamily="default"),void 0===t.appearance.styles.directoriesIconSize&&void 0!==t.appearance.styles.bookmarksIconSize&&(t.appearance.styles.directoriesIconSize=t.appearance.styles.bookmarksIconSize),e.api.storage.sync.remove(["clickCounter"]),e.api.storage.sync.set({behaviour:t.behaviour}),e.api.storage.sync.set({appearance:t.appearance}),e.api.storage.sync.set({newtab:t.newtab})})}},window.ViewAmountHelper=function(t){this.getAll=(()=>new Promise(e=>{a().then(a=>{e({viewAmounts:a,counterStartDate:t.helper.model.getData("installationDate")})})})),this.addByUrl=(e=>new Promise(a=>{null===t.helper.model.getData("openedByExtension")&&t.helper.bookmarkApi.func.search({url:e.url}).then(t=>{t.some(t=>t.url===e.url&&(this.addByEntry(t),!0)),a()}),t.helper.model.setData("openedByExtension",null)})),this.addByEntry=(i=>{i.id&&a().then(a=>{void 0===a[i.id]&&(a[i.id]={c:0}),"object"!=typeof a[i.id]&&(a[i.id]={c:a[i.id]}),a[i.id].c++,a[i.id].d=+new Date,delete a["node_"+i.id],e.api.storage.local.set({clickCounter:a},()=>{t.helper.entries.update()})})});let a=()=>new Promise(t=>{e.api.storage.local.get(["clickCounter"],e=>{let a={};void 0!==e.clickCounter&&(a=e.clickCounter),t(a)})})},e.api=e.api||window.browser||window.chrome;(new function(){let t=!1;this.urls={check404:"https://extensions.blockbyte.de/",updateUrls:"https://extensions.blockbyte.de/ajax/updateUrls",uninstall:"https://extensions.blockbyte.de/bs/uninstall"},this.refreshAllTabs=(t=>new Promise(a=>{Promise.all([this.helper.newtab.updateConfig(),this.helper.cache.remove({name:"html"}),this.helper.entries.update()]).then(()=>{e.api.tabs.query({},i=>{i.forEach(a=>{e.api.tabs.sendMessage(a.id,{action:"refresh",scrollTop:t.scrollTop||!1,type:t.type})}),a()})})}));let a=async()=>{e.api.browserAction.onClicked.addListener(()=>{e.api.tabs.query({active:!0,currentWindow:!0},t=>{e.api.tabs.sendMessage(t[0].id,{action:"toggleSidebar"})})}),e.api.bookmarks.onImportBegan.addListener(()=>{t=!0}),e.api.bookmarks.onImportEnded.addListener(()=>{t=!1,this.refreshAllTabs({type:"Created"})}),["Changed","Created","Removed"].forEach(a=>{e.api.bookmarks["on"+a].addListener(()=>{!1!==t&&"Created"===a||this.refreshAllTabs({type:a})})})},i=()=>{this.helper={model:new window.ModelHelper(this),bookmarkApi:new window.BookmarkApi(this),language:new window.LanguageHelper(this),updates:new window.UpdatesHelper(this),viewAmount:new window.ViewAmountHelper(this),newtab:new window.NewtabHelper(this),entries:new window.EntriesHelper(this),port:new window.PortHelper(this),icon:new window.IconHelper(this),cache:new window.CacheHelper(this),analytics:new window.AnalyticsHelper(this)}};this.run=(()=>{e.api.runtime.setUninstallURL(this.urls.uninstall),i();let t=+new Date;Promise.all([this.helper.model.init(),this.helper.icon.init(),this.helper.newtab.init(),this.helper.analytics.init(),this.helper.bookmarkApi.init()]).then(()=>Promise.all([a(),this.helper.port.init(),this.helper.updates.init(),this.helper.entries.update()])).then(()=>{console.log("LOADED",+new Date-t)})})}).run()})(jsu);