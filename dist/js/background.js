/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";new function(a){let t=null,n={},o={},r=!1,i={},s=[],l=!1,c=e=>{e.id&&B().then(a=>{void 0===a[e.id]&&(a[e.id]={c:0}),"object"!=typeof a[e.id]&&(a[e.id]={c:a[e.id]}),a[e.id].c++,a[e.id].d=+new Date,delete a["node_"+e.id],chrome.storage.local.set({clickCounter:a})})},d=e=>new Promise(a=>{if(c(e),e.newTab&&!0===e.newTab){let t=(t=null)=>{chrome.tabs.query({active:!0,currentWindow:!0},o=>{chrome.tabs.create({url:e.href,active:void 0===e.active||!!e.active,index:null===t?o[0].index+1:t,openerTabId:o[0].id},e=>{n.openedByExtension=e.id,A().then(a)})})};"afterLast"===e.position?chrome.tabs.query({},e=>{t(e[e.length-1].index+1)}):"beforeFirst"===e.position?t(0):t()}else e.incognito&&!0===e.incognito?(chrome.windows.create({url:e.href,state:"maximized",incognito:!0}),a()):chrome.tabs.query({active:!0,currentWindow:!0},t=>{chrome.tabs.update(t[0].id,{url:e.href},e=>{n.openedByExtension=e.id,A().then(a)})})}),h=e=>new Promise(a=>{let t=new Image;t.onload=function(){let e=document.createElement("canvas");e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0);let t=e.toDataURL("image/png");a({img:t})},t.src="chrome://favicon/size/16@2x/"+e.url}),m=e=>new Promise(e=>{B().then(a=>{e({viewAmounts:a,counterStartDate:n.installationDate})})}),u=e=>new Promise(a=>{o.getSubTree(e.id).then(e=>{a({bookmarks:e})})}),g=e=>new Promise(a=>{o.search(e.searchVal).then(e=>{a({bookmarks:e})})}),p=e=>new Promise(a=>{void 0===n.openedByExtension&&o.search({url:e.url}).then(t=>{t.some(a=>a.url===e.url&&(c(a),!0)),a()}),delete n.openedByExtension,A()}),b=e=>new Promise(a=>{let t={parentId:""+e.parentId,index:e.index};o.move(e.id,t).then(()=>{a({moved:e.id})})}),w=e=>new Promise(a=>{let t={title:e.title};e.url&&(t.url=e.url),o.update(e.id,t).then(()=>{a({updated:e.id})},e=>{a({error:e})})}),v=e=>new Promise(a=>{let t={parentId:e.parentId,index:e.index||0,title:e.title,url:e.url?e.url:null};o.create(t).then(()=>{a({created:e.id})},e=>{a({error:e})})}),y=e=>new Promise(a=>{o.removeTree(e.id).then(()=>{a({deleted:e.id})})}),k=t=>new Promise(n=>{t.abort&&!0===t.abort?e.cancelXhr(a.urls.updateUrls):e.xhr(a.urls.updateUrls,{method:"POST",data:{urlList:t.urls,ua:navigator.userAgent,lang:chrome.i18n.getUILanguage()}}).then(e=>{let a=JSON.parse(e.responseText);n(a)},()=>{n({error:!0})})}),f=e=>new Promise(e=>{N().then(a=>{e({infos:a})})}),x=a=>new Promise(t=>{if(a.lang){let n=void 0===a.cache||!0===a.cache;if(i[a.lang]&&n)t({langVars:i[a.lang]});else{let o=o=>{let r=o.langVars;e.xhr(chrome.extension.getURL("_locales/"+a.lang+"/messages.json")).then(e=>{let o=JSON.parse(e.responseText);Object.assign(r,o),n&&(i[a.lang]=r),t({langVars:r})})};a.defaultLang&&a.defaultLang!==a.lang?x({lang:a.defaultLang,cache:!1}).then(o):o({langVars:{}})}}}),P=e=>new Promise(e=>{let a=!1;null===t&&(+new Date-n.installationDate)/864e5>5&&(a=!0),e({showMask:a})}),D=t=>new Promise(t=>{e.xhr(a.urls.check404,{method:"HEAD",timeout:5e3}).then(()=>{t({status:"available"})},()=>{t({status:"unavailable"})})}),I=e=>new Promise(a=>{chrome.tabs.query({},t=>{t.forEach(a=>{chrome.tabs.sendMessage(a.id,{action:"refresh",scrollTop:e.scrollTop||!1,type:e.type})}),a()})}),S=e=>new Promise(a=>{chrome.storage.sync.set({shareUserdata:e.share},()=>{t=e.share,a()})}),T=(e,a=!1)=>new Promise(t=>{L({hitType:"event",eventCategory:e.category,eventAction:e.action,eventLabel:e.label,eventValue:e.value||1},a),t()}),E=(e,a=!1)=>new Promise(t=>{L({hitType:"pageview",page:e.page},a),t()}),L=(e,a)=>{!0!==t&&!0!==a||(s.push(e),!1===l&&U())},U=()=>{l=!0,e.delay(1e3).then(()=>{if(s.length>0&&window.ga&&window.ga.loaded){let e=s.shift();window.ga("send",e),U()}else l=!1})},C=async()=>{let e={checkUrls:k,addViewAmount:p,bookmarks:u,searchBookmarks:g,moveBookmark:b,updateBookmark:w,createBookmark:v,deleteBookmark:y,refreshAllTabs:I,shareUserdata:S,shareUserdataMask:P,languageInfos:f,langvars:x,favicon:h,openLink:d,websiteStatus:D,trackPageView:E,trackEvent:T,viewAmounts:m};chrome.extension.onMessage.addListener((a,t,n)=>(e[a.type]&&e[a.type](a).then(e=>{n(e)}),!0))},O=async()=>{chrome.browserAction.onClicked.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.tabs.sendMessage(e[0].id,{action:"toggleSidebar"})})}),chrome.bookmarks.onImportBegan.addListener(()=>{r=!0}),chrome.bookmarks.onImportEnded.addListener(()=>{r=!1,I({type:"Created"})}),["Changed","Created","Removed"].forEach(e=>{chrome.bookmarks["on"+e].addListener(()=>{!1!==r&&"Created"===e||I({type:e})})})},j=async()=>{chrome.runtime.onUpdateAvailable.addListener(()=>{chrome.runtime.reload()}),chrome.runtime.onInstalled.addListener(e=>{if("install"===e.reason)chrome.tabs.create({url:chrome.extension.getURL("html/intro.html")});else if("update"===e.reason){let a=chrome.runtime.getManifest().version,t=e.previousVersion.split("."),o=a.split(".");chrome.storage.local.remove(["languageInfos"]),T({category:"extension",action:"update",label:e.previousVersion+" -> "+a},!0),t[0]===o[0]&&t[1]===o[1]||(chrome.storage.sync.get(["model"],e=>{void 0===e.model||void 0!==e.model.updateNotification&&e.model.updateNotification===a||(n.updateNotification=a,A().then(()=>{chrome.tabs.create({url:chrome.extension.getURL("html/changelog.html")})}))}),chrome.storage.sync.get(null,e=>{void 0===e.behaviour&&(e.behaviour={}),void 0===e.appearance&&(e.appearance={}),delete e.behaviour.scrollSensitivity,void 0===e.appearance.styles&&(e.appearance.styles={}),void 0!==e.appearance.styles.fontFamily&&"Roboto"===e.appearance.styles.fontFamily&&(e.appearance.styles.fontFamily="default"),void 0===e.appearance.styles.directoriesIconSize&&void 0!==e.appearance.styles.bookmarksIconSize&&(e.appearance.styles.directoriesIconSize=e.appearance.styles.bookmarksIconSize),chrome.storage.sync.remove(["clickCounter"]),delete e.behaviour.hideEmptyDirs,void 0===e.appearance.styles.colorScheme&&(e.appearance.styles.colorScheme="rgb(0,137,123)"),void 0===e.behaviour.initialOpenOnNewTab&&(e.behaviour.initialOpenOnNewTab="de"===chrome.i18n.getUILanguage()),delete e.appearance.addVisual,delete e.behaviour.rememberScroll,delete e.behaviour.model,delete e.behaviour.clickCounter,delete e.behaviour.clickCounterStartDate,void 0!==e.appearance.styles.bookmarksDirIcon&&"dir"===e.appearance.styles.bookmarksDirIcon&&(e.appearance.styles.bookmarksDirIcon="dir-1"),chrome.storage.sync.set({behaviour:e.behaviour}),chrome.storage.sync.set({appearance:e.appearance})}))}})},A=()=>new Promise(e=>{Object.getOwnPropertyNames(n).length>0&&chrome.storage.sync.set({model:n},()=>{e()})}),B=()=>new Promise(e=>{chrome.storage.local.get(["clickCounter"],a=>{let t={};void 0!==a.clickCounter&&(t=a.clickCounter),e(t)})}),N=()=>new Promise(t=>{chrome.storage.local.get(["languageInfos"],n=>{if(n&&n.languageInfos&&(+new Date-n.languageInfos.updated)/36e5<8)t(n.languageInfos.infos);else{let n=Object.keys(a.langs).length,o=0,r={};Object.keys(a.langs).forEach(i=>{r[i]={name:i,label:a.langs[i],available:!1};let s=()=>{++o===n&&(chrome.storage.local.set({languageInfos:{infos:r,updated:+new Date}}),t(r))};e.xhr(chrome.extension.getURL("_locales/"+i+"/messages.json"),{method:"HEAD"}).then(()=>{r[i].available=!0,s()},s)})}})}),V=()=>{let e=chrome.runtime.getManifest(),a="not_set";if(!0===t?a="allowed":!1===t&&(a="not_allowed"),T({category:"extension",action:"user",label:"share_"+a},!0),T({category:"extension",action:"version",label:e.version},!0),!0===t){n.installationDate&&T({category:"extension",action:"installationDate",label:new Date(n.installationDate).toISOString().slice(0,10)}),o.getSubTree("0").then(e=>{let a=0,t=e=>{for(let n=0;n<e.length;n++){let o=e[n];o.url?a++:o.children&&t(o.children)}};e&&e[0]&&e[0].children&&e[0].children.length>0&&t(e[0].children),T({category:"extension",action:"bookmarks",label:"amount",value:a})});let e=["behaviour","appearance"],a=(e,t)=>{Object.keys(t).forEach(n=>{"object"==typeof t[n]?a(e+"_"+n,t[n]):("string"!=typeof t[n]&&(t[n]=JSON.stringify(t[n])),T({category:"configuration",action:e+"_"+n,label:t[n]}))})};chrome.storage.sync.get(e,t=>{e.forEach(e=>{"object"==typeof t[e]&&a(e,t[e])})})}},R=async()=>{chrome.storage.sync.get(["model","shareUserdata"],e=>{n=e.model||{},t=void 0===e.shareUserdata?null:e.shareUserdata,void 0===n.installationDate&&(n.installationDate=+new Date);let a=+(new Date).setHours(0,0,0,0);void 0!==n.lastTrackDate&&n.lastTrackDate===a||(n.lastTrackDate=a,V()),A()})},_=async()=>{window.GoogleAnalyticsObject="ga",window.ga=window.ga||function(){(window.ga.q=window.ga.q||[]).push(arguments)},window.ga.l=+new Date;let e=document.createElement("script");e.async=1,e.src=a.ga.url;let t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t);let n=chrome.runtime.getManifest();window.ga("create","UA-"+a.ga.trackingCode["Dev"!==n.version_name&&"update_url"in n?"live":"dev"],"auto"),window.ga("set","checkProtocolTask",null),window.ga("set","transport","beacon")},z=async()=>{let e=(e,a)=>new Promise((t,n)=>{chrome.bookmarks[e](...a,e=>{let a=chrome.runtime.lastError;void 0===a?t(e):n(a.message)})});["get","getSubTree","removeTree"].forEach(a=>{o[a]=(t=>e(a,[""+t]))}),["update","move"].forEach(a=>{o[a]=((t,n)=>e(a,[""+t,n]))}),["create","search"].forEach(a=>{o[a]=(t=>e(a,[t]))})};this.run=(()=>{chrome.runtime.setUninstallURL(a.urls.uninstall),Promise.all([_(),z(),R()]).then(()=>{O(),C(),j()})})}({ga:{url:"https://www.google-analytics.com/analytics.js",trackingCode:{dev:"100595538-3",live:"100595538-2"}},urls:{check404:"https://blockbyte.de/extensions",updateUrls:"https://blockbyte.de/ajax/extensions/updateUrls",uninstall:"https://blockbyte.de/extensions/bs/uninstall",onboarding:"https://blockbyte.de/extensions/bs/install"},langs:{af:"Afrikaans",ar:"Arabic",hy:"Armenian",be:"Belarusian",bg:"Bulgarian",ca:"Catalan","zh-CN":"Chinese (Simplified)","zh-TW":"Chinese (Traditional)",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch",en:"English",eo:"Esperanto",et:"Estonian",tl:"Filipino",fi:"Finnish",fr:"French",de:"German",el:"Greek",iw:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",it:"Italian",ja:"Japanese",ko:"Korean",lv:"Latvian",lt:"Lithuanian",no:"Norwegian",fa:"Persian",pl:"Polish",pt:"Portuguese",ro:"Romanian",ru:"Russian",sr:"Serbian",sk:"Slovak",sl:"Slovenian",es:"Spanish",sw:"Swahili",sv:"Swedish",ta:"Tamil",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese"}}).run()})(jsu);