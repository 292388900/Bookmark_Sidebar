/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";window.CheckboxHelper=function(t){let s={};this.get=((s,o,i="checkbox",l="default")=>{let r=e("<div />").html("<input type='checkbox' />").data("uid",Math.random().toString(36).substr(2,12)).attr(t.opts.attr.type,i).attr(t.opts.attr.style,l).addClass(t.opts.classes.checkbox.box);return o&&(r.children("input[type='checkbox']").attr(o),o[t.opts.attr.name]&&r.attr(t.opts.attr.name,o[t.opts.attr.name])),this.isChecked(r)&&r.addClass(t.opts.classes.checkbox.active),a(r,s),r}),this.isChecked=(e=>e.find("input[type='checkbox']")[0].checked);let o=(e,s)=>{let o=e.children("input[type='checkbox']");o.trigger("change"),t.opts.events&&t.opts.events.checkboxChanged&&t.helper.utility.triggerEvent("checkboxChanged",{container:e,checkbox:o,checked:e.hasClass(t.opts.classes.checkbox.active)},s.document()[0])},i=(a,l)=>{a.addClass(t.opts.classes.checkbox.clicked),a.removeClass(t.opts.classes.checkbox.focus),a.toggleClass(t.opts.classes.checkbox.active);let r=a.hasClass(t.opts.classes.checkbox.active),n=a.children("input[type='checkbox']");if("radio"===a.attr(t.opts.attr.type)&&a.attr(t.opts.attr.name))if(l){let s=a.attr(t.opts.attr.name);a.addClass(t.opts.classes.checkbox.active),r&&(n.attr("checked",!0),o(a,l)),l.find("div."+t.opts.classes.checkbox.box+"["+t.opts.attr.type+"='radio']["+t.opts.attr.name+"='"+s+"']").forEach(t=>{let s=e(t);t!==a[0]&&this.isChecked(s)&&i(s)})}else n.attr("checked",!1);else n.attr("checked",r),o(a,l);let c=a.data("uid");s[c]&&clearTimeout(s[c]),s[c]=setTimeout(()=>{a.removeClass(t.opts.classes.checkbox.clicked)},300)},a=(s,o)=>{s.on("mousedown",s=>{s.preventDefault(),s.stopPropagation(),e(s.currentTarget).addClass(t.opts.classes.checkbox.focus)}).on("click",t=>{t.preventDefault(),t.stopPropagation(),i(e(t.currentTarget),o)}),o.on("click",()=>{s.removeClass(t.opts.classes.checkbox.focus)})}},window.changelog=function(){let t={};this.opts={elm:{body:e("body"),title:e("head > title"),contentWrapper:e("body > main"),changelogWrapper:e("article#changelog"),releaseHistoryWrapper:e("article#releaseHistory"),versionInfo:e("main > div.version > span")},classes:{building:"building",initLoading:"initLoading",visible:"visible",error:"error",checkbox:{box:"checkbox",active:"active",clicked:"clicked",focus:"focus"}},attr:{type:"data-type",style:"data-style"},ajax:{versionHistory:"https://extensions.blockbyte.de/ajax/changelog/bs"},manifest:chrome.runtime.getManifest()},this.run=(()=>{s();let i=this.helper.template.loading().appendTo(this.opts.elm.body);this.opts.elm.body.addClass(this.opts.classes.initLoading),this.helper.model.init().then(()=>this.helper.i18n.init()).then(()=>(this.opts.elm.body.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.font.init("default"),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["changelog"],e(document)),this.helper.i18n.parseHtml(document),this.opts.elm.title.text(this.opts.elm.title.text()+" - "+this.helper.i18n.get("extension_name")),this.opts.elm.versionInfo.text(this.opts.manifest.version_name),this.helper.model.call("trackPageView",{page:"/changelog"}))).then(()=>(this.opts.elm.body.removeClass(this.opts.classes.building),Promise.all([r(),e.delay(700)]))).then(()=>{t&&t.changelog&&t.releaseHistory?(o(),a(),l()):e("<p />").addClass(this.opts.classes.error).text(this.helper.i18n.get("status_changelog_unavailable_desc")).appendTo(this.opts.elm.contentWrapper),i.remove(),this.opts.elm.body.removeClass(this.opts.classes.initLoading)})});let s=()=>{this.helper={i18n:new window.I18nHelper(this),font:new window.FontHelper(this),template:new window.TemplateHelper(this),stylesheet:new window.StylesheetHelper(this),checkbox:new window.CheckboxHelper(this),model:new window.ModelHelper(this)}},o=()=>{let t=this.helper.checkbox.get(this.opts.elm.body,{},"checkbox","switch").prependTo(this.opts.elm.contentWrapper);e("<a />").html(this.helper.i18n.get("changelog_show_release_history")).insertAfter(t).on("click",e=>{e.preventDefault(),t.trigger("click")}),t.children("input[type='checkbox']").on("change",e=>{e.currentTarget.checked?(this.opts.elm.releaseHistoryWrapper.addClass(this.opts.classes.visible),this.opts.elm.changelogWrapper.removeClass(this.opts.classes.visible)):(this.opts.elm.releaseHistoryWrapper.removeClass(this.opts.classes.visible),this.opts.elm.changelogWrapper.addClass(this.opts.classes.visible))})},i=e=>{if("Dev"===this.opts.manifest.version_name||!("update_url"in this.opts.manifest))return!1;let t=null,s=/(\.0+)+$/,o=this.opts.manifest.version.replace(s,"").split("."),i=e.replace(s,"").split("."),a=Math.max(o.length,i.length);for(let e=0;e<a;e++)if(t=parseInt(o[e]||0,10)-parseInt(i[e]||0,10))return t<0;return!1},a=()=>{t&&t.changelog&&(Object.entries(t.changelog).forEach(([t,s])=>{if(!1===i(t)){let o=e("<div />").append("<h2>"+t+"</h2>").appendTo(this.opts.elm.changelogWrapper),i=e("<ul />").appendTo(o);s.forEach(t=>{e("<li />").html(t).appendTo(i)})}}),this.opts.elm.changelogWrapper.addClass(this.opts.classes.visible))},l=()=>{t&&t.releaseHistory&&t.releaseHistory.forEach(t=>{if(!1===i(t.version)){let s=e("<div />").append("<h2>"+t.version+"</h2>").appendTo(this.opts.elm.releaseHistoryWrapper),o=e("<ul />").appendTo(s);t.changes.forEach(t=>{e("<li />").html(t).appendTo(o)})}})},r=()=>new Promise(s=>{e.xhr(this.opts.ajax.versionHistory,{method:"POST",responseType:"json"}).then(e=>{e.response&&e.response.changelog&&e.response.releaseHistory&&(t=e.response),s()},()=>{s()})})},(new window.changelog).run()})(jsu);