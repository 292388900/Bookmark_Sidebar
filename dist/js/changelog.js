/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";window.changelog=function(){let t={};this.opts={elm:{body:e("body"),title:e("head > title"),contentWrapper:e("body > main"),changelogWrapper:e("article#changelog"),releaseHistoryWrapper:e("article#releaseHistory"),versionInfo:e("main > div.version > span")},classes:{building:"building",initLoading:"initLoading",visible:"visible",error:"error",checkbox:{box:"checkbox",active:"active",clicked:"clicked",focus:"focus"}},attr:{type:"data-type",style:"data-style"},ajax:{versionHistory:"https://extensions.blockbyte.de/ajax/changelog/bs"},manifest:chrome.runtime.getManifest()},this.run=(()=>{s();let l=this.helper.template.loading().appendTo(this.opts.elm.body);this.opts.elm.body.addClass(this.opts.classes.initLoading),this.helper.model.init().then(()=>this.helper.i18n.init()).then(()=>(this.opts.elm.body.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.font.init("default"),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["changelog"],e(document)),this.helper.i18n.parseHtml(document),this.opts.elm.title.text(this.opts.elm.title.text()+" - "+this.helper.i18n.get("extension_name")),this.opts.elm.versionInfo.text(this.opts.manifest.version_name),this.helper.model.call("trackPageView",{page:"/changelog"}))).then(()=>(this.opts.elm.body.removeClass(this.opts.classes.building),Promise.all([a(),e.delay(700)]))).then(()=>{t&&t.changelog&&t.releaseHistory?(i(),o(),n()):e("<p />").addClass(this.opts.classes.error).text(this.helper.i18n.get("status_changelog_unavailable_desc")).appendTo(this.opts.elm.contentWrapper),l.remove(),this.opts.elm.body.removeClass(this.opts.classes.initLoading)})});let s=()=>{this.helper={i18n:new window.I18nHelper(this),font:new window.FontHelper(this),template:new window.TemplateHelper(this),stylesheet:new window.StylesheetHelper(this),checkbox:new window.CheckboxHelper(this),model:new window.ModelHelper(this)}},i=()=>{let t=this.helper.checkbox.get(this.opts.elm.body,{},"checkbox","switch").prependTo(this.opts.elm.contentWrapper);e("<a />").html(this.helper.i18n.get("changelog_show_release_history")).insertAfter(t).on("click",e=>{e.preventDefault(),t.trigger("click")}),t.children("input[type='checkbox']").on("change",e=>{e.currentTarget.checked?(this.opts.elm.releaseHistoryWrapper.addClass(this.opts.classes.visible),this.opts.elm.changelogWrapper.removeClass(this.opts.classes.visible)):(this.opts.elm.releaseHistoryWrapper.removeClass(this.opts.classes.visible),this.opts.elm.changelogWrapper.addClass(this.opts.classes.visible))})},l=e=>{if("Dev"===this.opts.manifest.version_name||!("update_url"in this.opts.manifest))return!1;let t=null,s=/(\.0+)+$/,i=this.opts.manifest.version.replace(s,"").split("."),l=e.replace(s,"").split("."),o=Math.max(i.length,l.length);for(let e=0;e<o;e++)if(t=parseInt(i[e]||0,10)-parseInt(l[e]||0,10))return t<0;return!1},o=()=>{t&&t.changelog&&(Object.entries(t.changelog).forEach(([t,s])=>{if(!1===l(t)){let i=e("<div />").append("<h2>"+t+"</h2>").appendTo(this.opts.elm.changelogWrapper),l=e("<ul />").appendTo(i);s.forEach(t=>{e("<li />").html(t).appendTo(l)})}}),this.opts.elm.changelogWrapper.addClass(this.opts.classes.visible))},n=()=>{t&&t.releaseHistory&&t.releaseHistory.forEach(t=>{if(!1===l(t.version)){let s=e("<div />").append("<h2>"+t.version+"</h2>").appendTo(this.opts.elm.releaseHistoryWrapper),i=e("<ul />").appendTo(s);t.changes.forEach(t=>{e("<li />").html(t).appendTo(i)})}})},a=()=>new Promise(s=>{e.xhr(this.opts.ajax.versionHistory,{method:"POST",responseType:"json"}).then(e=>{e.response&&e.response.changelog&&e.response.releaseHistory&&(t=e.response),s()},()=>{s()})})},(new window.changelog).run()})(jsu);