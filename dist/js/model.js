/*! (c) Philipp KÃ¶nig under GPL-3.0 */
"use strict";!function(){var a={},b=[],c={updateUrls:"https://moonware.de/ajax/extensions/updateUrls",userdata:"https://moonware.de/ajax/extensions/userdata"},d={get:function(a,b){chrome.bookmarks.get(""+a,b)},getSubTree:function(a,b){chrome.bookmarks.getSubTree(""+a,b)},removeTree:function(a,b){chrome.bookmarks.removeTree(""+a,b)},update:function(a,b,c){chrome.bookmarks.update(""+a,b,c)},move:function(a,b,c){chrome.bookmarks.move(""+a,b,c)},search:function(a,b){chrome.bookmarks.search(a,b)}},e=function(b){b.id&&("undefined"==typeof a.clickCounter[b.id]&&("undefined"==typeof a.clickCounter["node_"+b.id]?a.clickCounter[b.id]=0:a.clickCounter[b.id]=a.clickCounter["node_"+b.id]),a.clickCounter[b.id]++,delete a.clickCounter["node_"+b.id],t())},f=function(b,c){e(b),b.newTab&&b.newTab===!0?chrome.tabs.query({active:!0,currentWindow:!0},function(c){chrome.tabs.create({url:b.href,active:"undefined"==typeof b.active||!!b.active,index:c[0].index+1,openerTabId:c[0].id},function(b){a.openedByExtension=b.id,t()})}):chrome.tabs.query({active:!0,currentWindow:!0},function(c){chrome.tabs.update(c[0].id,{url:b.href},function(b){a.openedByExtension=b.id,t()})})},g=function(a,b){var c=new Image;c.onload=function(){var a=document.createElement("canvas");a.width=this.width,a.height=this.height;var c=a.getContext("2d");c.drawImage(this,0,0);var d=a.toDataURL("image/png");b({img:d})},c.src="chrome://favicon/size/16@2x/"+a.url},h=function(b,c){c({views:a.clickCounter[b.id]||a.clickCounter["node_"+b.id]||0,counterStartDate:a.installationDate})},i=function(a,b){d.getSubTree(a.id,function(a){b({bookmarks:a})})},j=function(a,b){d.search(a.searchVal,function(a){b({bookmarks:a})})},k=function(b,c){"undefined"==typeof a.openedByExtension&&d.search({url:b.url},function(a){a.some(function(a){return a.url===b.url&&(e(a),!0)})}),delete a.openedByExtension,t()},l=function(a,b){var c={parentId:""+a.parentId,index:a.index};d.move(a.id,c,function(){b({moved:a.id})})},m=function(a,b){var c={title:a.title};a.url&&(c.url=a.url),d.update(a.id,c,function(){b({updated:a.id})})},n=function(a,b){d.removeTree(a.id,function(){b({deleted:a.id})})},o=function(a,d){a.abort&&a.abort===!0?b.forEach(function(a){a.abort()}):!function(){var e=new XMLHttpRequest;e.open("POST",c.updateUrls,!0),e.onload=function(){var a=JSON.parse(e.responseText);d(a)};var f=new FormData;f.append("url",a.url),f.append("ua",navigator.userAgent),f.append("lang",chrome.i18n.getUILanguage()),e.send(f),b.push(e)}()},p=function(b,c){chrome.storage.sync.set({shareUserdata:b.share}),a.lastShareDate=0,t()},q=function(a,b){d.get(a.id,function(a){var c=a[0];c.parents=[];var e=function a(e){e.parentId&&"0"!==e.parentId?d.get(e.parentId,function(b){b&&b[0]&&b[0].id&&(c.parents.push(b[0].id),a(b[0]))}):b(c)};e(c)})},r=function(b,c){d.getSubTree(b.id,function(b){var d=0,e={bookmarks:0,dirs:0,total:0},f=function b(c){c.forEach(function(c){e.total++,c.children?e.dirs++:(e.bookmarks++,a.clickCounter[c.id]?d+=a.clickCounter[c.id]:a.clickCounter["node_"+c.id]&&(d+=a.clickCounter["node_"+c.id])),c.children&&c.children.length>0&&b(c.children)})};b[0]&&b[0].children&&b[0].children.length>0&&f(b[0].children),c({childrenAmount:e,clickAmount:d,counterStartDate:a.installationDate})})},s={realUrl:o,addViewAmount:k,dirInfos:r,bookmarkInfos:q,bookmarks:i,searchBookmarks:j,moveBookmark:l,updateBookmark:m,deleteBookmark:n,shareUserdata:p,favicon:g,openLink:f,viewAmount:h};chrome.extension.onMessage.addListener(function(a,b,c){return s[a.type]&&s[a.type](a,c),!0}),chrome.browserAction.onClicked.addListener(function(){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{action:"toggleSidebar"})})}),chrome.runtime.onInstalled.addListener(function(a){if("install"===a.reason)chrome.tabs.create({url:chrome.extension.getURL("html/howto.html")});else if("update"===a.reason){var b=a.previousVersion.split("."),c=chrome.runtime.getManifest().version.split(".");b[0]===c[0]&&b[1]===c[1]||(chrome.tabs.create({url:chrome.extension.getURL("html/changelog.html")}),chrome.storage.sync.get(null,function(a){if(a.appearance){if("undefined"!=typeof a.model.shareUserdata&&"undefined"==typeof a.shareUserdata){var b=a.model.shareUserdata;"y"===b?chrome.storage.sync.set({shareUserdata:!0}):"n"===b?chrome.storage.sync.set({shareUserdata:!0}):"boolean"==typeof b&&chrome.storage.sync.set({shareUserdata:b})}return!1}var c={model:{},utility:{},behaviour:{},appearance:{}};"undefined"==typeof a.openAction&&(a.openAction="contextmenu"),Object.keys(a).forEach(function(b){var d=a[b];switch("y"===d&&(d=!0),"n"===d&&(d=!1),/^\{.*\}$/.test(d)&&(d=JSON.parse(d)),"middleClickActive"===b&&"undefined"==typeof a.newTab&&(b="newTab",d=d===!0?"foreground":"background"),"pxTolerance"===b&&("string"==typeof d&&0===d.search(/^\d+$/)||"number"==typeof d)&&(d={windowed:20,maximized:d}),b){case"openStates":case"searchValue":case"scrollPos":case"entriesLocked":c.utility[b]=d;break;case"openedByExtension":case"installationDate":case"clickCounter":case"lastShareDate":case"uuid":c.model[b]=d;break;case"shareUserdata":c[b]=d;break;case"addVisual":c.appearance[b]=d;break;case"utility":case"behaviour":case"appearance":break;default:c.behaviour[b]=d}"utility"!==b&&"behaviour"!==b&&"appearance"!==b&&chrome.storage.sync.remove([b])}),chrome.storage.sync.set(c,function(){u()})}))}});var t=function(){chrome.storage.sync.set({model:a})},u=function(){chrome.storage.sync.get(["model","shareUserdata"],function(b){a=b.model||{},"undefined"==typeof a.uuid&&(a.uuid=function(){var a=+new Date;return window.performance&&"function"==typeof window.performance.now&&(a+=window.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:3&c|8).toString(16)})}()),"undefined"==typeof a.clickCounter&&(a.clickCounter={}),"undefined"==typeof a.installationDate?a.installationDate=+new Date:"undefined"==typeof b.shareUserdata&&(+new Date-a.installationDate)/864e5>5&&setTimeout(function(){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{action:"showShareUserdataMask"})})},6e4),t()})},v=function(){chrome.storage.sync.get(null,function(b){"undefined"!=typeof b.model&&"undefined"!=typeof b.model.uuid&&("undefined"==typeof b.model.lastShareDate||(+new Date-b.model.lastShareDate)/36e5>8)&&!function(){a.lastShareDate=+new Date,t();var e=function(a){var b=new XMLHttpRequest;b.open("POST",c.userdata,!0);var d=new FormData;d.append("data",JSON.stringify(a)),b.send(d)},f=chrome.runtime.getManifest();b.uuid=b.model.uuid,"Dev"!==f.version_name&&"update_url"in f||(b.uuid="Dev"),b.extension={name:f.name,version:f.version},"undefined"!=typeof b.shareUserdata&&b.shareUserdata===!0?d.getSubTree("0",function(a){b.bookmarkAmount=0;var c=function a(c){for(var d=0;d<c.length;d++){var e=c[d];e.url?b.bookmarkAmount++:e.children&&a(e.children)}};a&&a[0]&&a[0].children&&a[0].children.length>0&&c(a[0].children),b.ua=navigator.userAgent,b.lang=chrome.i18n.getUILanguage(),b.installationDate=b.model.installationDate,delete b.utility,delete b.model,e(b)}):e({uuid:b.uuid,extension:b.extension,shareUserdata:"undefined"==typeof b.shareUserdata?"undefined":b.shareUserdata})}()})};!function(){u(),v()}()}();