/*! (c) Philipp KÃ¶nig under GPL-3.0 */
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e=null,a={},n=null,t=[],o={updateUrls:"https://blockbyte.de/ajax/extensions/updateUrls",userdata:"https://blockbyte.de/ajax/extensions/userdata"},r={},i={af:"Afrikaans",ar:"Arabic",hy:"Armenian",be:"Belarusian",bg:"Bulgarian",ca:"Catalan","zh-CN":"Chinese (Simplified)","zh-TW":"Chinese (Traditional)",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch",en:"English",eo:"Esperanto",et:"Estonian",tl:"Filipino",fi:"Finnish",fr:"French",de:"German",el:"Greek",iw:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",it:"Italian",ja:"Japanese",ko:"Korean",lv:"Latvian",lt:"Lithuanian",no:"Norwegian",fa:"Persian",pl:"Polish",pt:"Portuguese",ro:"Romanian",ru:"Russian",sr:"Serbian",sk:"Slovak",sl:"Slovenian",es:"Spanish",sw:"Swahili",sv:"Swedish",ta:"Tamil",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese"},s={get:function(e,a){chrome.bookmarks.get(""+e,a)},getSubTree:function(e,a){chrome.bookmarks.getSubTree(""+e,a)},removeTree:function(e,a){chrome.bookmarks.removeTree(""+e,a)},update:function(e,a,n){chrome.bookmarks.update(""+e,a,n)},create:function(e,a){chrome.bookmarks.create(e,a)},move:function(e,a,n){chrome.bookmarks.move(""+e,a,n)},search:function(e,a){chrome.bookmarks.search(e,a)}},c=function(e){e.id&&m(null,function(){void 0===n.data[e.id]&&(void 0===n.data["node_"+e.id]?n.data[e.id]={c:0}:n.data[e.id]={c:n.data["node_"+e.id]}),"object"!==_typeof(n.data[e.id])&&(n.data[e.id]={c:n.data[e.id]}),n.data[e.id].c++,n.data[e.id].d=+new Date,delete n.data["node_"+e.id];!function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sync";n.storageType=t,chrome.storage[t].set({clickCounter:n},function(){var t=chrome.runtime.lastError;void 0===t?a.clickCounter&&(delete a.clickCounter,u()):"sync"===n.storageType&&-1!==t.message.search("QUOTA_BYTES_PER_ITEM")&&(e("local"),chrome.storage.sync.remove(["clickCounter"]))})}()})},l=function(e){chrome.tabs.query({},function(a){a.forEach(function(a){chrome.tabs.sendMessage(a.id,{action:"refresh",scrollTop:e.scrollTop||!1,type:e.type})})})},d={realUrl:function(e,a){if(e.abort&&!0===e.abort)t.forEach(function(e){e.abort()});else{var n=new XMLHttpRequest;n.open("POST",o.updateUrls,!0),n.onload=function(){var e=JSON.parse(n.responseText);a(e)};var r=new FormData;r.append("url",e.url),r.append("ua",navigator.userAgent),r.append("lang",chrome.i18n.getUILanguage()),n.send(r),t.push(n)}},addViewAmount:function(e){void 0===a.openedByExtension&&s.search({url:e.url},function(a){a.some(function(a){return a.url===e.url&&(c(a),!0)})}),delete a.openedByExtension,u()},bookmarks:function(e,a){s.getSubTree(e.id,function(e){a({bookmarks:e})})},searchBookmarks:function(e,a){s.search(e.searchVal,function(e){a({bookmarks:e})})},moveBookmark:function(e,a){var n={parentId:""+e.parentId,index:e.index};s.move(e.id,n,function(){a({moved:e.id})})},updateBookmark:function(e,a){var n={title:e.title};e.url&&(n.url=e.url),s.update(e.id,n,function(){var n=chrome.runtime.lastError;a(void 0===n?{updated:e.id}:{error:n.message})})},createBookmark:function(e,a){var n={parentId:e.parentId,index:e.index||0,title:e.title,url:e.url?e.url:null};s.create(n,function(){var n=chrome.runtime.lastError;a(void 0===n?{created:e.id}:{error:n.message})})},deleteBookmark:function(e,a){s.removeTree(e.id,function(){a({deleted:e.id})})},refreshAllTabs:l,shareUserdata:function(n){chrome.storage.sync.set({shareUserdata:n.share}),e=n.share,a.lastShareDate=0,u()},shareUserdataMask:function(n,t){var o=!1;null===e&&(+new Date-a.installationDate)/864e5>5&&(o=!0),t({showMask:o})},languageInfos:function(e,a){f(function(e){a({infos:e})})},langvars:function e(a,n){if(a.lang){var t=void 0===a.cache||!0===a.cache;if(r[a.lang]&&t)n({langVars:r[a.lang]});else{var o=function(e){var o=e.langVars,i=new XMLHttpRequest;i.open("GET",chrome.extension.getURL("_locales/"+a.lang+"/messages.json"),!0),i.onload=function(){var e=JSON.parse(i.responseText);Object.assign(o,e),t&&(r[a.lang]=o),n({langVars:o})},i.send()};a.defaultLang&&a.defaultLang!==a.lang?e({lang:a.defaultLang,cache:!1},o):o({langVars:{}})}}},favicon:function(e,a){var n=new Image;n.onload=function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0);var n=e.toDataURL("image/png");a({img:n})},n.src="chrome://favicon/size/16@2x/"+e.url},openLink:function(e){c(e),e.newTab&&!0===e.newTab?chrome.tabs.query({active:!0,currentWindow:!0},function(n){chrome.tabs.create({url:e.href,active:void 0===e.active||!!e.active,index:n[0].index+1,openerTabId:n[0].id},function(e){a.openedByExtension=e.id,u()})}):e.incognito&&!0===e.incognito?chrome.windows.create({url:e.href,state:"maximized",incognito:!0}):chrome.tabs.query({active:!0,currentWindow:!0},function(n){chrome.tabs.update(n[0].id,{url:e.href},function(e){a.openedByExtension=e.id,u()})})},viewAmounts:function(e,t){m(null,function(){t({viewAmounts:n.data,counterStartDate:a.installationDate})})}};chrome.extension.onMessage.addListener(function(e,a,n){return d[e.type]&&d[e.type](e,n),!0}),chrome.browserAction.onClicked.addListener(function(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:"toggleSidebar"})})}),["Changed","Created","Removed"].forEach(function(e){chrome.bookmarks["on"+e].addListener(function(){l({type:e})})}),chrome.runtime.onInstalled.addListener(function(e){if("install"===e.reason)chrome.tabs.create({url:chrome.extension.getURL("html/howto.html")});else if("update"===e.reason){var n=chrome.runtime.getManifest().version,t=e.previousVersion.split("."),o=n.split(".");chrome.storage.local.remove(["languageInfos"]),t[0]===o[0]&&t[1]===o[1]||(chrome.storage.sync.get(["model"],function(e){void 0===e.model||void 0!==e.model.updateNotification&&e.model.updateNotification===n||(a.updateNotification=n,u(function(){chrome.tabs.create({url:chrome.extension.getURL("html/changelog.html")})}))}),chrome.storage.sync.get(null,function(e){if(e.behaviour&&(void 0===e.behaviour.rememberState&&void 0!==e.behaviour.rememberScroll&&(e.behaviour.rememberState=!1===e.behaviour.rememberScroll?"openStates":"all"),delete e.behaviour.rememberScroll,delete e.behaviour.model,delete e.behaviour.clickCounter,delete e.behaviour.clickCounterStartDate,chrome.storage.sync.set({behaviour:e.behaviour})),void 0===e.appearance&&(e.appearance={}),void 0===e.appearance.styles&&(e.appearance.styles={}),void 0===e.appearance.styles.bookmarksDirIcon||"dir"===e.appearance.styles.bookmarksDirIcon?e.appearance.styles.bookmarksDirIcon="dir-2":"dir-alt1"===e.appearance.styles.bookmarksDirIcon?(e.appearance.styles.bookmarksDirIcon="dir-1",e.appearance.styles.bookmarksDirColor="rgb(240,180,12)"):"dir-alt2"===e.appearance.styles.bookmarksDirIcon&&(e.appearance.styles.bookmarksDirIcon="dir-1"),delete e.appearance.addVisual,chrome.storage.sync.set({appearance:e.appearance}),!e.shareUserdata||"n"!==e.shareUserdata&&"y"!==e.shareUserdata||chrome.storage.sync.set({shareUserdata:"y"===e.shareUserdata}),chrome.storage.sync.remove(["clickCounter","lastShareDate","scrollPos","openStates","installationDate","uuid","entriesLocked","addVisual","middleClickActive"]),e.model&&void 0!==e.model.shareUserdata&&void 0===e.shareUserdata){var a=e.model.shareUserdata;"y"===a?chrome.storage.sync.set({shareUserdata:!0}):"n"===a?chrome.storage.sync.set({shareUserdata:!0}):"boolean"==typeof a&&chrome.storage.sync.set({shareUserdata:a})}}))}});var u=function(e){Object.getOwnPropertyNames(a).length>0&&chrome.storage.sync.set({model:a},function(){"function"==typeof e&&e()})},m=function e(t,o){t||(t="sync"),chrome.storage[t].get(["clickCounter"],function(r){void 0===r.clickCounter?"sync"===t?e("local",o):(n={storageType:"sync",data:a.clickCounter||{}},"function"==typeof o&&o()):(n={storageType:t,data:r.clickCounter.data},"function"==typeof o&&o())})},h=function(){chrome.storage.sync.get(["model","shareUserdata"],function(n){a=n.model||{},e=void 0===n.shareUserdata?null:n.shareUserdata,void 0===a.uuid&&(a.uuid=function(){var e=+new Date;return window.performance&&"function"==typeof window.performance.now&&(e+=window.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===a?n:3&n|8).toString(16)})}()),void 0===a.installationDate&&(a.installationDate=+new Date),m(),u()})},f=function(e){chrome.storage.local.get(["languageInfos"],function(a){if(a&&a.languageInfos&&(+new Date-a.languageInfos.updated)/36e5<8)"function"==typeof e&&e(a.languageInfos.infos);else{var n=Object.keys(i).length,t=0,o={};Object.keys(i).forEach(function(a){o[a]={name:a,label:i[a],available:!1};var r=new XMLHttpRequest;["load","error"].forEach(function(i){r.addEventListener(i,function(){t++,"load"===i&&(o[a].available=!0),t===n&&(chrome.storage.local.set({languageInfos:{infos:o,updated:+new Date}}),"function"==typeof e&&e(o))})}),r.open("HEAD",chrome.extension.getURL("_locales/"+a+"/messages.json"),!0),r.send()})}})},p=function(){chrome.storage.sync.get(null,function(e){if(void 0!==e.model&&void 0!==e.model.uuid&&(void 0===e.model.lastShareDate||(+new Date-e.model.lastShareDate)/36e5>8)){a.lastShareDate=+new Date,u();var n=function(e){var a=new XMLHttpRequest;a.open("POST",o.userdata,!0);var n=new FormData;n.append("data",JSON.stringify(e)),a.send(n)},t=chrome.runtime.getManifest();e.uuid=e.model.uuid,"Dev"!==t.version_name&&"update_url"in t||(e.uuid="Dev"),e.extension={name:t.name,version:t.version},void 0!==e.shareUserdata&&!0===e.shareUserdata?s.getSubTree("0",function(a){e.bookmarkAmount=0;a&&a[0]&&a[0].children&&a[0].children.length>0&&function a(n){for(var t=0;t<n.length;t++){var o=n[t];o.url?e.bookmarkAmount++:o.children&&a(o.children)}}(a[0].children),e.ua=navigator.userAgent,e.lang=chrome.i18n.getUILanguage(),e.installationDate=e.model.installationDate,delete e.utility,delete e.model,delete e.clickCounter,n(e)}):n({uuid:e.uuid,extension:e.extension,shareUserdata:void 0===e.shareUserdata?"undefined":e.shareUserdata})}})};!function(){h(),p()}()}();