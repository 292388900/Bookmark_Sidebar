/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(e=>{"use strict";window.EditHelper=function(t){let s=!1;this.init=(async()=>{s=location.href.search(/#edit$/)>-1,e("EDITBUTTON").on("click",e=>{e.preventDefault(),s||history.pushState({},null,location.href+"#edit")})})},window.SearchHelper=function(t){let s={};this.init=(async()=>{n()});let o=s=>{let o=e("ul."+t.opts.classes.suggestions+" > li."+t.opts.classes.active),l="next"===s?0:-1;o.length()>0&&(l=o.prevAll("li").length()+("next"===s?1:-1),o.removeClass(t.opts.classes.active));let i=!1;if(l>=0){let s=e("ul."+t.opts.classes.suggestions+" > li").eq(l);s.length()>0&&(i=!0,s.addClass(t.opts.classes.active),t.opts.elm.search.field[0].value=s.text().trim())}!1===i&&(t.opts.elm.search.field[0].value=t.opts.elm.search.field.data("typedVal"))},l=e=>{e&&e.trim().length>0&&(0===e.search(/https?\:\/\//)||0===e.search(/s?ftps?\:\/\//)||0===e.search(/chrome\:\/\//)?chrome.tabs.update({url:e}):chrome.tabs.update({url:"https://www.google.com/search?q="+encodeURIComponent(e)}))},i=t=>new Promise(o=>{if(t)if(s[t])o(s[t]);else{let l=encodeURIComponent(t),i=(e=[])=>{s[t]=e,o(e)};e.xhr("http://google.com/complete/search?client=chrome&q="+l,{responseType:"json"}).then(e=>{try{if(e.response&&e.response[0]===t){let t=[],s=[];e.response[1].forEach((o,l)=>{"NAVIGATION"===e.response[4]["google:suggesttype"][l]?t.push({type:"url",label:o}):s.push({type:"word",label:o})}),i(t.concat(s))}}catch(e){i()}},()=>{i()})}else o([])}),n=()=>{t.opts.elm.search.submit.on("click",e=>{e.preventDefault(),e.stopPropagation();let s=t.opts.elm.search.field[0].value;s&&s.trim().length>0?l(s):chrome.tabs.update({url:"https://www.google.com"})}),t.opts.elm.search.field.on("keyup click",s=>{s.preventDefault(),s.stopPropagation();let n=s.currentTarget.value,a=event.which||event.keyCode;13===a?l(n):40===a?o("next"):38===a?o("prev"):(t.opts.elm.search.field.data("typedVal",n),i(n).then(s=>{if(e("ul."+t.opts.classes.suggestions).remove(),s.length>0){let o=e("<ul />").addClass(t.opts.classes.suggestions).insertAfter(t.opts.elm.search.field);s.some((s,l)=>{if(e("<li />").attr(t.opts.attr.type,s.type).text(s.label).appendTo(o),l>4)return!0}),o.css({top:t.opts.elm.search.field[0].offsetTop+"px",left:t.opts.elm.search.field[0].offsetLeft+"px"})}}))}),e(document).on("mousemove","ul."+t.opts.classes.suggestions+" > li",s=>{e("ul."+t.opts.classes.suggestions+" > li").removeClass(t.opts.classes.active),e(s.currentTarget).addClass(t.opts.classes.active)}).on("click","ul."+t.opts.classes.suggestions+" > li",s=>{s.preventDefault(),s.stopPropagation();let o=e(s.currentTarget).text().trim();t.opts.elm.search.field[0].value=o,l(o)}),e(document).on("click",()=>{e("ul."+t.opts.classes.suggestions).remove(),t.opts.elm.search.field[0].focus()}),e(window).on("resize",()=>{e("ul."+t.opts.classes.suggestions).remove()})}},window.ShortcutsHelper=function(e){this.init=(async()=>{e.opts.elm.topNav.on("click","a."+e.opts.classes.chromeApps,e=>{e.preventDefault(),chrome.tabs.update({url:"chrome://apps"})})})},window.TopPagesHelper=function(t){let s=null;this.init=(async()=>{s=t.helper.model.getData("n/topPagesType"),o(),i()});let o=()=>{e(window).on("resize",()=>{let e=l(),s=t.opts.elm.topPages.children("li").length();e.total!==s&&i()})},l=()=>{let e={total:8,rows:2};return window.innerWidth>650?e.total=8:window.innerWidth>490?e.total=6:window.innerWidth>340?e.total=4:e.total=0,window.innerHeight<280?e.total=0:window.innerHeight<420&&(e.total/=2,e.rows=1),e},i=()=>{chrome.topSites.get(s=>{t.opts.elm.topPages.html("");let o=l();t.opts.elm.topPages.attr(t.opts.attr.perRow,o.total/o.rows),o.total>0&&s.some((s,l)=>{let i=e("<li />").html("<a href='"+s.url+"' title='"+s.title+"'><span>"+s.title+"</span></a>").appendTo(t.opts.elm.topPages);t.helper.model.call("favicon",{url:s.url}).then(e=>{e.img&&i.find("> a > span").prepend("<img src='"+e.img+"' />")});let n=e("<img />").appendTo(i.children("a"));if(t.helper.model.call("thumbnail",{url:s.url}).then(e=>{e.img&&n.attr("src",e.img).addClass(t.opts.classes.visible)}),l>=o.total-1)return!0})})}},window.newtab=function(){this.opts={classes:{building:"building",initLoading:"initLoading",loading:"loading",chromeApps:"chromeApps",suggestions:"suggestions",active:"active",visible:"visible",darkMode:"dark"},attr:{type:"data-type",perRow:"data-perRow"},elm:{body:e("body"),title:e("head > title"),content:e("section#content"),topNav:e("section#content > nav"),search:{field:e("div#search > input[type='text']"),submit:e("div#search > button[type='submit']")},topPages:e("ul.topPages")},manifest:chrome.runtime.getManifest()},this.run=(()=>{chrome.permissions.contains({permissions:["tabs","topSites"]},function(e){e?t():chrome.tabs.update({url:"chrome-search://local-ntp/local-ntp.html"})})});let t=()=>{o(),s();let t=this.helper.template.loading().appendTo(this.opts.elm.body);this.opts.elm.body.addClass(this.opts.classes.initLoading),this.helper.model.init().then(()=>(!0===this.helper.model.getData("a/darkMode")&&this.opts.elm.body.addClass(this.opts.classes.darkMode),this.helper.i18n.init())).then(()=>(this.helper.font.init(),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["newtab"],e(document)),this.helper.i18n.parseHtml(document),this.helper.topPages.init(),this.helper.search.init(),this.helper.shortcuts.init(),this.helper.edit.init(),e.delay(500))).then(()=>{t.remove(),this.opts.elm.body.removeClass([this.opts.classes.building,this.opts.classes.initLoading])})},s=()=>{this.helper={model:new window.ModelHelper(this),template:new window.TemplateHelper(this),i18n:new window.I18nHelper(this),font:new window.FontHelper(this),stylesheet:new window.StylesheetHelper(this),search:new window.SearchHelper(this),shortcuts:new window.ShortcutsHelper(this),topPages:new window.TopPagesHelper(this),edit:new window.EditHelper(this)}},o=()=>{this.opts.manifest.content_scripts[0].css.forEach(t=>{e("head").append("<link href='"+chrome.extension.getURL(t)+"' type='text/css' rel='stylesheet' />")});let t=(e=0)=>{let s=this.opts.manifest.content_scripts[0].js[e];if(void 0!==s){let o=document.createElement("script");document.head.appendChild(o),o.onload=(()=>t(e+1)),o.src="/"+s}};t()}},(new window.newtab).run()})(jsu);